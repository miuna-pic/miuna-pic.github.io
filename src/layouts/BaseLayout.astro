---
import {
  SITE_TAB,
  SITE_DESCRIPTION,
  SITE_FAVICON,
  SITE_LANGUAGE,
  SITE_THEME,
  SITE_PAGES,
  umamiConfig,
} from "@config";
import { ClientRouter } from "astro:transitions";
// import ElementCrossing from "astro-vtbot/components/ElementCrossing.astro";
// import PointerOnNavigation from "astro-vtbot/components/PointerOnNavigation.astro";
import Header from "@components/Header.astro";
import Sidebar from "@components/Sidebar.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";

import Banner from "@components/Banner.astro";
import GlobalAudio from "@components/widgets/GlobalAudio.astro";
import SakanaWidget from "@components/widgets/SakanaWidget.astro";
import GlobalToaster from "@components/GlobalToaster";

const {
  title,
  image,
  headings = [],
  showTOC = false,
  isIndexed = true,
  showSidebar = true,
  showBanner = true,
} = Astro.props;

// Ê†πÊçÆÂΩìÂâçË∑ØÂæÑ‰ªéÈÖçÁΩÆ‰∏≠Ëé∑Âèñ Banner ÂÜÖÂÆπ
const currentPath = Astro.url.pathname.replace("/", "") || "home";
const pageConfig = SITE_PAGES?.[currentPath];
const bannerTitle = pageConfig?.title || title || "";
const bannerSubtitle = pageConfig?.subtitle || "";
---

<!doctype html>
<html
  lang={SITE_LANGUAGE}
  style="background-color: var(--custom-page-bg)"
  data-theme={SITE_THEME.light}
  data-theme-type="light"
>
  <head>
    <ClientRouter />
    <!-- <ElementCrossing /> -->
    <!-- <PointerOnNavigation /> -->
    <Header
      title={title}
      description={SITE_DESCRIPTION}
      favicon={SITE_FAVICON}
      image={image}
    />
    <title>{`${title} - ${SITE_TAB}`}</title>

    <!-- UmamiÂàÜÊûêÔºàËá™Âª∫Ôºâ -->
    {
      umamiConfig.enable && umamiConfig.websiteId && (
        <script
          is:inline
          defer
          src={`${umamiConfig.baseUrl}/script.js`}
          data-website-id={umamiConfig.websiteId}
        />
      )
    }
    {
      umamiConfig.enable && (
        <script is:inline defer src="/js/umami-share.js"></script>
      )
    }




    <script is:inline data-light={SITE_THEME.light} data-dark={SITE_THEME.dark} id="theme-init">
      (function() {
        if (window.__THEME_INIT_V2__) return;
        window.__THEME_INIT_V2__ = true;

        var storedBannerMode = localStorage.getItem("banner-mode") || "normal";
        var t = localStorage.getItem("theme");
        
        // ‰ªéÂΩìÂâçËÑöÊú¨Ê†áÁ≠æËé∑ÂèñÈÖçÁΩÆÁöÑÈªòËÆ§‰∏ªÈ¢ò
        var script = document.getElementById("theme-init");
        var light = script ? script.getAttribute("data-light") : "light";
        var dark = script ? script.getAttribute("data-dark") : "dark";
        
        if (!t) {
          t = light;
          localStorage.setItem("theme", t);
        }
        
        document.documentElement.setAttribute("data-theme", t);
        document.documentElement.setAttribute("data-banner-mode", storedBannerMode);
        
        var isDark = t === dark || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(t);
        document.documentElement.setAttribute("data-theme-type", isDark ? "dark" : "light");
      })();
    </script>
  </head>

  <!-- ÁßªÈô§‰∏äËæπË∑ùÔºåËÆ©Banner‰ªéÈ°∂ÈÉ®ÂºÄÂßã -->
  <body
    class="flex flex-col min-h-screen bg-[var(--banner-wave-bg)] overflow-x-hidden w-full"
    {...isIndexed ? { "data-pagefind-body": true } : {}}
  >
    {showBanner && <Banner title={bannerTitle} subtitle={bannerSubtitle} />}
    <Navbar />
    <div class={`max-w-blog mx-auto w-full flex-grow page-content-animate ${showBanner ? 'mt-8' : 'mt-24'}`}>
      <div
        class={`grid grid-cols-1 ${showSidebar ? "md:grid-cols-5 lg:grid-cols-4" : ""} gap-4 px-4 pb-4 h-full`}
      >
        <main
          class={`col-span-1 ${showSidebar ? "md:col-span-4 lg:col-span-3" : "w-full"} bg-transparent order-1 md:order-2 flex flex-col gap-4`}
        >
          <div class="flex-grow flex flex-col gap-4">
            <slot />
          </div>
          <Footer />
        </main>
        {
          showSidebar && (
            <aside class="col-span-1 bg-transparent order-2 md:order-1 md:top-4 hidden md:block">
              <Sidebar headings={headings} showTOC={showTOC} />
              <slot name="sidebar" />
            </aside>
          )
        }
      </div>
    </div>


    <!-- <MobileTOC headings={headings} showTOC={showTOC} /> -->
    <GlobalAudio />
    <!-- <SakanaWidget /> -->

    <!-- ÂÖ∂‰ΩôËÑöÊú¨‰øùÊåÅ‰∏çÂèò -->
    <GlobalToaster client:only="react" />
    <script is:inline>
      (function() {
        if (window.__THEME_SWAP_INIT__) return;
        window.__THEME_SWAP_INIT__ = true;

        document.addEventListener("astro:after-swap", () => {
        var t = localStorage.getItem("theme");
        var m = localStorage.getItem("banner-mode") || "normal";
        
        if (t) {
          document.documentElement.setAttribute("data-theme", t);
          var isDark = t === 'dark' || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(t);
          document.documentElement.setAttribute("data-theme-type", isDark ? "dark" : "light");
        }
        
        document.documentElement.setAttribute("data-banner-mode", m);
      });
      })();
    </script>

    <script is:inline>
      document.addEventListener('click', (e) => {
        if (e.target.closest('a')) {
          console.log('üîó Link Clicked:', Date.now());
        }
      });
      document.addEventListener('astro:before-preparation', () => console.log('üöÄ Before Prep:', Date.now()));
      document.addEventListener('astro:after-preparation', () => console.log('üì¶ After Prep:', Date.now()));
      document.addEventListener('astro:before-swap', () => console.log('üîÑ Before Swap:', Date.now()));
      document.addEventListener('astro:page-load', () => {
        console.log('‚úÖ Page Loaded:', Date.now());
        document.querySelectorAll(".btn-copy").forEach((button) => {
          button.addEventListener("click", async () => {
            const codeBlock = button.closest(".ryuchan-code");
            const code = codeBlock.querySelector("code").textContent;
            const copyIcon = button.querySelector(
              ".ryuchan-code-toolbar-copy-icon",
            );
            const successIcon = button.querySelector(
              ".ryuchan-code-toolbar-copy-success",
            );
            try {
              await navigator.clipboard.writeText(code);
              copyIcon.classList.add("hidden");
              successIcon.classList.remove("hidden");
              button.classList.add("copy-success");
              window.dispatchEvent(new CustomEvent('app:toast', { 
                detail: { 
                  type: 'success', 
                  message: '‰ª£Á†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø' 
                } 
              }));
              setTimeout(() => {
                copyIcon.classList.remove("hidden");
                successIcon.classList.add("hidden");
                button.classList.remove("copy-success");
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
            }
          });
        });
      });
    </script>

    <style is:inline>
      .btn-copy {
        position: relative;
        overflow: hidden;
      }
      .copy-success {
        animation: pulse 0.5s ease-in-out;
      }
  .ryuchan-code-toolbar-copy-success svg {
        color: #10b981;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </body>
</html>
