---
interface Props {
  envId: string;
}

import Card from "@/components/temple/Card.astro";
import "@/styles/twikoo.css";
const { envId } = Astro.props;
---

<Card class="p-6">
  <div id="tcomment"></div>
</Card>

<script is:inline defer src="/js/twikoo.all.min.js"></script>

<script is:inline define:vars={{ envId }}>
  function initTwikoo() {
    const container = document.getElementById('tcomment');
    if (!container) return;
    
    // 如果已初始化，先清空再重新初始化
    if (container.classList.contains('twikoo-init')) {
      container.innerHTML = '';
      container.classList.remove('twikoo-init');
    }

    // 等待 twikoo 库加载
    function tryInit() {
      if (typeof twikoo !== 'undefined') {
        twikoo.init({
          envId: envId,
          el: '#tcomment',
        });
        container.classList.add('twikoo-init');
      } else {
        // 库还没加载，等待后重试
        setTimeout(tryInit, 100);
      }
    }
    
    tryInit();
  }

  // 初始加载时初始化
  initTwikoo();
  
  // 防止重复注册事件监听器
  if (!window.__twikooSwupListenerRegistered) {
    window.__twikooSwupListenerRegistered = true;
    // swup 页面切换后重新初始化
    document.addEventListener('swup:contentReplaced', initTwikoo);
  }
</script>
