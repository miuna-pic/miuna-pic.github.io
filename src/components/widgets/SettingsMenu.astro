---
import { Icon } from "astro-icon/components";
import { SITE_THEME } from "@config";

const themes = [
  { name: "light", color: "#ffffff" },
  { name: "dark", color: "#1d232a" },
  { name: "cupcake", color: "#65c3c8" },
  { name: "bumblebee", color: "#e0a82e" },
  { name: "emerald", color: "#66cc8a" },
  { name: "corporate", color: "#4b6bfb" },
  { name: "synthwave", color: "#e779c1" },
  { name: "retro", color: "#ef9995" },
  { name: "cyberpunk", color: "#ff7598" },
  { name: "valentine", color: "#e96d7b" },
  { name: "halloween", color: "#f28c18" },
  { name: "garden", color: "#fe0075" },
  { name: "forest", color: "#1eb854" },
  { name: "aqua", color: "#09ecf3" },
  { name: "lofi", color: "#808080" },
  { name: "pastel", color: "#d1c1d7" },
  { name: "fantasy", color: "#6e0b75" },
  { name: "wireframe", color: "#b8b8b8" },
  { name: "black", color: "#000000" },
  { name: "luxury", color: "#ffffff" },
  { name: "dracula", color: "#ff79c6" },
  { name: "cmyk", color: "#45AEEE" },
  { name: "autumn", color: "#8C0327" },
  { name: "business", color: "#1C4E80" },
  { name: "acid", color: "#FF00F4" },
  { name: "lemonade", color: "#519903" },
  { name: "night", color: "#38bdf8" },
  { name: "coffee", color: "#DB924B" },
  { name: "winter", color: "#047AFF" },
];
---

<details class="dropdown dropdown-end" id="desktop-settings-details">
  <summary class="btn btn-ghost btn-circle hover:bg-white/10 text-primary" title="Settings">
    <Icon name="material-symbols:settings-outline" class="w-6 h-6" />
  </summary>
  <ul class="dropdown-content z-[100] menu p-2 shadow-2xl bg-base-100 rounded-box w-64 mt-4 border border-base-200">
    <!-- Dark/Light Toggle -->
    <li>
      <button id="desktop-theme-toggle" class="flex justify-between items-center gap-2 p-2 hover:bg-base-200 rounded-lg w-full">
        <span class="font-medium">Dark/Light</span>
        <div class="btn btn-ghost btn-circle btn-sm text-primary hover:bg-primary/10 hover:scale-110 transition-all duration-300 pointer-events-none flex items-center justify-center">
          <Icon name="line-md:moon-alt-to-sunny-outline-loop-transition" class="w-5 h-5 light-icon" />
          <Icon name="line-md:sunny-outline-to-moon-alt-loop-transition" class="w-5 h-5 dark-icon hidden" />
        </div>
      </button>
    </li>

    <!-- Banner Mode Settings -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:image-outline" class="w-5 h-5" />
            Banner Mode
          </div>
        </summary>
        <ul class="p-2 bg-base-100 rounded-box">
          <li>
            <button data-set-banner-desktop="normal" class="flex gap-2">
              <Icon name="material-symbols:panorama-outline" class="w-5 h-5" />
              Normal
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="fullscreen" class="flex gap-2">
              <Icon name="material-symbols:fullscreen" class="w-5 h-5" />
              Fullscreen
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="background" class="flex gap-2">
              <Icon name="material-symbols:wallpaper" class="w-5 h-5" />
              Background
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="hidden" class="flex gap-2">
              <Icon name="material-symbols:hide-image-outline" class="w-5 h-5" />
              Hidden
            </button>
          </li>
        </ul>
      </details>
    </li>

    <!-- Config Button -->


    <!-- Theme Selector -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:palette-outline" class="w-5 h-5" />
            Theme
          </div>
        </summary>
        <ul class="p-2 bg-base-100 rounded-box max-h-60 overflow-y-auto flex-nowrap">
          {themes.map((theme) => (
            <li>
              <button
                class="flex gap-3 items-center"
                data-set-theme-desktop={theme.name}
                aria-label={`Change theme to ${theme.name}`}
              >
                <span class="w-4 h-4 rounded-full border border-base-content/20" style={`background-color: ${theme.color};`}></span>
                <span class="capitalize">{theme.name}</span>
              </button>
            </li>
          ))}
        </ul>
      </details>
    </li>

    <!-- Custom Theme -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:format-paint" class="w-5 h-5" />
            Custom Theme
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Primary Color</span>
            <input type="color" id="custom-primary-picker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" />
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Background Color</span>
            <input type="color" id="custom-bg-picker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" />
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Text Color</span>
            <input type="color" id="custom-text-picker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" />
          </div>
          <button id="reset-custom-theme" class="btn btn-xs btn-outline w-full mt-2">Reset to Preset</button>
        </div>
      </details>
    </li>

    <!-- Network Status -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:wifi" class="w-5 h-5" />
            Network Status
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-1 cursor-default min-w-[200px]">
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">Ping</span>
            <span id="network-ping" class="text-xs font-bold font-mono">-- ms</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">IP</span>
            <span id="network-ip" class="text-xs font-mono truncate max-w-[140px]" title="IP Address">...</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">Loc</span>
            <span id="network-country" class="text-xs font-mono truncate max-w-[140px]" title="Location">...</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">ASN</span>
            <span id="network-asn" class="text-xs font-mono truncate max-w-[140px]" title="ASN">...</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">ISP</span>
            <span id="network-isp" class="text-xs font-mono truncate max-w-[140px]" title="ISP">...</span>
          </div>
          <div class="flex justify-between items-center px-1">

            <span class="text-xs opacity-70">NAT</span>
            <span id="network-nat" class="text-xs font-mono truncate max-w-[140px]">...</span>
          </div>
          <button id="refresh-network-status" class="btn btn-xs btn-outline w-full mt-2">Refresh</button>

        </div>
      </details>
    </li>

    <!-- Base64 Tool -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:code" class="w-5 h-5" />
            Base64 Tool
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
          <textarea id="b64-input" class="textarea textarea-bordered textarea-xs w-full h-16 resize-none" placeholder="Input..."></textarea>
          <div class="grid grid-cols-2 gap-2">
            <button id="b64-encode-btn" class="btn btn-xs btn-primary">Encode</button>
            <button id="b64-decode-btn" class="btn btn-xs btn-secondary">Decode</button>
          </div>
          <div class="relative">
            <textarea id="b64-output" class="textarea textarea-bordered textarea-xs w-full h-16 resize-none font-mono" placeholder="Result..." readonly></textarea>
            <button id="b64-copy-btn" class="btn btn-xs btn-ghost btn-square absolute top-1 right-1" title="Copy">
               <Icon name="material-symbols:content-copy-outline" class="w-4 h-4" />
            </button>
          </div>
        </div>
      </details>
    </li>

    <!-- Extra Features -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:auto-awesome" class="w-5 h-5" />
            Extra Features
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
          <!-- Snowflakes Toggle -->
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Snowflakes</span>
            <input type="checkbox" id="toggle-snowflakes" class="toggle toggle-primary toggle-sm" />
          </div>
          <!-- FPS Counter Toggle -->
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">FPS Counter</span>
            <input type="checkbox" id="toggle-fps" class="toggle toggle-primary toggle-sm" />
          </div>
          <!-- Heart Click Toggle -->
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Heart Click</span>
            <input type="checkbox" id="toggle-heart" class="toggle toggle-primary toggle-sm" />
          </div>
        </div>
      </details>
    </li>

    <!-- Anime Trace Tool -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:image-search" class="w-5 h-5" />
            Anime Trace
          </div>
        </summary>
        <div id="desktop-animetrace-container" class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
           <input type="file" id="animetrace-file" accept="image/*" class="file-input file-input-bordered file-input-xs w-full" />
           <select id="animetrace-model" class="select select-bordered select-xs w-full">
             <option value="animetrace_high_beta" selected>High Quality (Beta)</option>
             <option value="pre_stable">Anime</option>
             <option value="anime_model_lovelive">LoveLive (Legacy)</option>
             <option value="full_game_model_kira">GalGame (Legacy)</option>
           </select>
           <button id="animetrace-btn" class="btn btn-xs btn-primary w-full">Search</button>
           <div id="animetrace-result" class="text-xs font-mono bg-base-200 p-2 rounded max-h-40 overflow-y-auto hidden whitespace-pre-wrap"></div>
        </div>
      </details>
    </li>


    <!-- Activity Status -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:monitor-heart-outline" class="w-5 h-5" />
            Activity
          </div>
        </summary>
        <div id="desktop-activity-container" class="p-2 bg-base-100 rounded-box flex flex-col gap-1 cursor-default min-w-[200px]">
          <!-- PC -->
          <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-2 text-xs opacity-70">
              <Icon name="material-symbols:computer-outline" class="w-3.5 h-3.5" />
              <span>PC</span>
            </div>
            <span id="desktop-activity-pc" class="text-xs font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">Loading...</span>
          </div>
          <!-- Phone -->
          <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-2 text-xs opacity-70">
              <Icon name="material-symbols:phone-android-outline" class="w-3.5 h-3.5" />
              <span>Phone</span>
            </div>
            <span id="desktop-activity-phone" class="text-xs font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">Loading...</span>
          </div>
          <!-- Tablet -->
          <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-2 text-xs opacity-70">
              <Icon name="material-symbols:tablet-android-outline" class="w-3.5 h-3.5" />
              <span>Tablet</span>
            </div>
            <span id="desktop-activity-tablet" class="text-xs font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">Loading...</span>
          </div>
          <!-- Music -->
          <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-2 text-xs opacity-70">
              <Icon name="lucide:music" class="w-3.5 h-3.5" />
              <span>Music</span>
            </div>
            <span id="desktop-activity-music" class="text-xs font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">Loading...</span>
          </div>
        </div>
      </details>
    </li>

    <!-- Site Info -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:info-outline" class="w-5 h-5" />
            Site Info
          </div>
        </summary>
        <div id="desktop-site-info-container" class="p-2 bg-base-100 rounded-box flex flex-col gap-1 cursor-default min-w-[200px]">
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">Last Update</span>
            <span id="site-last-update" class="text-xs font-mono truncate max-w-[120px]">...</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">Commit</span>
            <a id="site-commit-hash" href="#" target="_blank" class="text-xs font-mono text-base-content hover:underline truncate max-w-[120px]">...</a>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-xs opacity-70">Actions</span>
            <span id="site-actions-status" class="text-xs font-mono">...</span>
          </div>
          <button id="refresh-site-info" class="btn btn-xs btn-outline w-full mt-2">Refresh</button>
        </div>
      </details>
    </li>

  </ul>
</details>

<script is:inline define:vars={{ SITE_THEME }}>
  document.addEventListener("DOMContentLoaded", () => {
    // Prevent dropdown close on container click
    document.getElementById('desktop-animetrace-container')?.addEventListener('click', e => e.stopPropagation());
    document.getElementById('desktop-activity-container')?.addEventListener('click', e => e.stopPropagation());
    document.getElementById('desktop-site-info-container')?.addEventListener('click', e => e.stopPropagation());

    // ========== Activity Status Logic ==========
    const ACTIVITY_API_URL = 'https://activity.000.moe/api/activity';
    const DESKTOP_DEVICE_MAP = {
        'PC': 'desktop-activity-pc',
        'Phone': 'desktop-activity-phone',
        'Tablet': 'desktop-activity-tablet',
        'Music': 'desktop-activity-music'
    };

    const updateDesktopActivity = async () => {
        try {
            const res = await fetch(ACTIVITY_API_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error('API unstable');
            const data = await res.json();
            const devices = data.devices || {};

            for (const [device, elId] of Object.entries(DESKTOP_DEVICE_MAP)) {
                const el = document.getElementById(elId);
                if (!el) continue;
                const deviceData = devices[device] || { app: 'Offline', updatedAt: null };
                
                if (deviceData.updatedAt && Date.now() - new Date(deviceData.updatedAt).getTime() > 5 * 60 * 1000) {
                    el.textContent = 'Offline';
                } else {
                    let displayName = deviceData.app || 'Offline';
                    // 对于音乐设备，只显示歌曲名（移除 " - Artist" 部分）
                    if (device === 'Music' && displayName !== 'Offline' && displayName.includes(' - ')) {
                        displayName = displayName.split(' - ')[0];
                    }
                    el.textContent = displayName;
                }
            }
        } catch (e) {
            console.error('Desktop activity error:', e);
            Object.values(DESKTOP_DEVICE_MAP).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'Offline';
            });
        }
    };

    updateDesktopActivity();
    if (window._desktopActivityInterval) clearInterval(window._desktopActivityInterval);
    window._desktopActivityInterval = setInterval(updateDesktopActivity, 10000);


    // Theme classification
    const DARK_THEMES = ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee', 'dim', 'sunset'];
    const isDarkTheme = (theme) => DARK_THEMES.includes(theme);

    // Base64 Logic
    const b64Input = document.getElementById('b64-input');
    const b64Output = document.getElementById('b64-output');
    const b64Encode = document.getElementById('b64-encode-btn');
    const b64Decode = document.getElementById('b64-decode-btn');
    const b64Copy = document.getElementById('b64-copy-btn');

    const utf8_to_b64 = (str) => {
        try {
            return window.btoa(new TextEncoder().encode(str).reduce((data, byte) => data + String.fromCharCode(byte), ''));
        } catch (e) {
            return "Error: Invalid Input";
        }
    };

    const b64_to_utf8 = (str) => {
        try {
            return new TextDecoder().decode(Uint8Array.from(window.atob(str), c => c.charCodeAt(0)));
        } catch (e) {
            return "Error: Invalid Base64";
        }
    };

    if (b64Encode && b64Decode && b64Input && b64Output) {
        b64Encode.addEventListener('click', () => {
            b64Output.value = utf8_to_b64(b64Input.value);
        });

        b64Decode.addEventListener('click', () => {
            b64Output.value = b64_to_utf8(b64Input.value);
        });
        
        if (b64Copy) {
            b64Copy.addEventListener('click', () => {
                if (b64Output.value) {
                    navigator.clipboard.writeText(b64Output.value);
                    // Visual feedback could be added here
                    b64Copy.classList.add('text-success');
                    setTimeout(() => b64Copy.classList.remove('text-success'), 1000);
                }
            });
        }
    }

    // Network Status Logic
    const checkNetworkStatus = async () => {
        const pingEl = document.getElementById('network-ping');
        const ipEl = document.getElementById('network-ip');
        const countryEl = document.getElementById('network-country');
        const asnEl = document.getElementById('network-asn');
        const ispEl = document.getElementById('network-isp');
        const natEl = document.getElementById('network-nat');
        
        if (!pingEl || !ipEl) return;

        // Reset
        pingEl.textContent = '...';
        pingEl.className = 'text-xs font-bold font-mono';
        ipEl.textContent = '...';
        if (countryEl) countryEl.textContent = '...';
        if (asnEl) asnEl.textContent = '...';
        if (ispEl) ispEl.textContent = '...';
        if (natEl) natEl.textContent = '...';

        // Check Ping
        // Check Ping (Best of 3)
        try {
            let minDuration = Infinity;
            for (let i = 0; i < 3; i++) {
                const start = performance.now();
                await fetch(window.location.href, { method: 'HEAD', cache: 'no-store' });
                const duration = performance.now() - start;
                if (duration < minDuration) minDuration = duration;
            }
            minDuration = Math.round(minDuration);
            
            pingEl.textContent = `${minDuration} ms`;
            if (minDuration < 200) pingEl.classList.add('text-success');
            else if (minDuration < 500) pingEl.classList.add('text-warning');
            else pingEl.classList.add('text-error');
        } catch (e) {
            pingEl.textContent = 'Err';
            pingEl.classList.add('text-error');
        }

        // Check Info (IP, Loc, ASN, ISP)
        try {
            const res = await fetch('https://api.ip.sb/geoip', { referrerPolicy: 'no-referrer' });
            const data = await res.json();
            ipEl.textContent = data.ip;
            if (countryEl) countryEl.textContent = `${data.country_code}`;
            if (asnEl) asnEl.textContent = `AS${data.asn}`;
            if (ispEl) ispEl.textContent = data.isp.length > 15 ? data.isp.substring(0, 15) + '...' : data.isp;
        } catch (e) {
            // Fallback to Cloudflare Trace (IP only)
            try {
                const res = await fetch('https://www.cloudflare.com/cdn-cgi/trace');
                const text = await res.text();
                const ip = text.match(/ip=(.+)/)?.[1] || 'Unknown';
                ipEl.textContent = ip;
                if (countryEl) countryEl.textContent = text.match(/loc=(.+)/)?.[1] || '?';
                if (asnEl) asnEl.textContent = '-';
                if (ispEl) ispEl.textContent = '-';
            } catch (ex) {
                ipEl.textContent = 'Error';
            }
        }

        // Check NAT Type (WebRTC)
        if (natEl) {
            natEl.textContent = 'Detecting...';
            natEl.className = 'text-xs font-mono';
            
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.chat.bilibili.com:3478' }] });
            let candidatesCount = 0;
            const publicIpRef = ipEl.textContent; 

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    candidatesCount++;
                    const c = e.candidate;
                    
                    // Check No Nat (Public IP) - if valid public IP matches local host candidate
                    if (c.type === 'host' && c.address === publicIpRef && publicIpRef !== 'Switching to fallback...' && publicIpRef !== 'Unknown') {
                         natEl.textContent = 'Public IP';
                         natEl.classList.add('text-success');
                         pc.close();
                         return;
                    }
                    
                    if (c.type === 'srflx') {
                         // Found a reflex candidate -> Behind NAT (Assume Restricted Cone as standard)
                         natEl.textContent = 'Restricted';
                         natEl.classList.remove('text-success');
                    }
                } else {
                    if (candidatesCount === 0) {
                         natEl.textContent = 'Symmetric';
                         natEl.classList.add('text-error');
                    } else if (natEl.textContent === 'Detecting...') {
                         // Fallback
                         natEl.textContent = 'Symmetric'; 
                    }
                    pc.close();
                }
            };
            
            try {
                pc.createDataChannel("");
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
            } catch (e) {
                natEl.textContent = 'Failed';
            }
        }
    };

    const refreshBtn = document.getElementById('refresh-network-status');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', checkNetworkStatus);
    }
    checkNetworkStatus();

    // Color conversion: Hex -> OKLCH
    
    function hexToRgb(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    }

    function srgbTransfer(v) {
        v /= 255;
        return v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    }
    
    function rgbToOklch(r, g, b) {
        const lr = srgbTransfer(r);
        const lg = srgbTransfer(g);
        const lb = srgbTransfer(b);
        
        const l = 0.4122214708 * lr + 0.5363325363 * lg + 0.0514459929 * lb;
        const m = 0.2119034982 * lr + 0.6806995451 * lg + 0.1073969566 * lb;
        const s = 0.0883024619 * lr + 0.2817188376 * lg + 0.6302787005 * lb;
        
        const l_ = Math.cbrt(l);
        const m_ = Math.cbrt(m);
        const s_ = Math.cbrt(s);
        
        const L = 0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_;
        const a = 1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_;
        const b_ = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_;
        
        const C = Math.sqrt(a * a + b_ * b_);
        let H = Math.atan2(b_, a) * 180 / Math.PI;
        if (H < 0) H += 360;
        
        return `${L.toFixed(3)} ${C.toFixed(3)} ${H.toFixed(3)}`;
    }

    function updateCustomTheme(type, hex) {
        const [r, g, b] = hexToRgb(hex);
        const oklch = rgbToOklch(r, g, b);

        if (type === 'primary') {
            document.documentElement.style.setProperty('--p', oklch);
            document.documentElement.style.setProperty('--s', oklch); 
            document.documentElement.style.setProperty('--a', oklch);
            localStorage.setItem('custom-primary-hex', hex);

            const pPicker = document.getElementById('custom-primary-picker');
            const mPicker = document.getElementById('mobile-custom-primary-picker');
            if (pPicker) pPicker.value = hex;
            if (mPicker) mPicker.value = hex;
        } else if (type === 'bg') {
            document.documentElement.style.setProperty('--b1', oklch);
            document.documentElement.style.setProperty('--b2', oklch);
            document.documentElement.style.setProperty('--b3', oklch);
            document.documentElement.style.setProperty('--n', oklch);
            document.documentElement.style.setProperty('--neu-base', oklch); 
            document.documentElement.style.setProperty('--neu-btn-bg', oklch);
            localStorage.setItem('custom-bg-hex', hex);

            const bPicker = document.getElementById('custom-bg-picker');
            const mPicker = document.getElementById('mobile-custom-bg-picker');
            if (bPicker) bPicker.value = hex;
            if (mPicker) mPicker.value = hex;
        } else if (type === 'text') {
            document.documentElement.style.setProperty('--bc', oklch);
            document.documentElement.style.setProperty('--nc', oklch);
            document.documentElement.style.setProperty('--neu-text', oklch);
            document.documentElement.style.setProperty('--neu-btn-text', oklch);
            localStorage.setItem('custom-text-hex', hex);

            const tPicker = document.getElementById('custom-text-picker');
            const mPicker = document.getElementById('mobile-custom-text-picker');
            if (tPicker) tPicker.value = hex;
            if (mPicker) mPicker.value = hex;
        }
    }

    // Initialize Custom Colors
    const savedPrimary = localStorage.getItem('custom-primary-hex');
    if (savedPrimary) updateCustomTheme('primary', savedPrimary);

    const savedBg = localStorage.getItem('custom-bg-hex');
    if (savedBg) updateCustomTheme('bg', savedBg);

    const savedText = localStorage.getItem('custom-text-hex');
    if (savedText) updateCustomTheme('text', savedText);

    // Listeners
    const primaryPicker = document.getElementById('custom-primary-picker');
    if (primaryPicker) {
        primaryPicker.addEventListener('input', (e) => updateCustomTheme('primary', e.target.value));
    }
    const bgPicker = document.getElementById('custom-bg-picker');
    if (bgPicker) {
        bgPicker.addEventListener('input', (e) => updateCustomTheme('bg', e.target.value));
    }
    const textPicker = document.getElementById('custom-text-picker');
    if (textPicker) {
        textPicker.addEventListener('input', (e) => updateCustomTheme('text', e.target.value));
    }
    
    // Reset Logic
    const resetButton = document.getElementById('reset-custom-theme');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            ['--p', '--s', '--a', '--b1', '--b2', '--b3', '--n', '--bc', '--nc', '--neu-base', '--neu-text', '--neu-btn-bg', '--neu-btn-text'].forEach(prop => {
                document.documentElement.style.removeProperty(prop);
            });
            
            localStorage.removeItem('custom-primary-hex');
            localStorage.removeItem('custom-bg-hex');
            localStorage.removeItem('custom-text-hex');
            
             if (primaryPicker) primaryPicker.value = '#000000';
             if (bgPicker) bgPicker.value = '#000000';
             if (textPicker) textPicker.value = '#000000';
        });
    }

    // Dark/Light Toggle Logic
    const desktopThemeToggle = document.getElementById("desktop-theme-toggle");
    
    const updateDesktopThemeIcons = (theme) => {
      const isDark = isDarkTheme(theme);
      
      // Update attribute
      document.documentElement.setAttribute('data-theme-type', isDark ? 'dark' : 'light');

      if (!desktopThemeToggle) return;
      const lightIcon = desktopThemeToggle.querySelector(".light-icon");
      const darkIcon = desktopThemeToggle.querySelector(".dark-icon");
      
      if (lightIcon && darkIcon) {
        if (isDark) {
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }
    };

    // Initialize icon state
    const currentTheme = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme");
    updateDesktopThemeIcons(currentTheme);

    if (desktopThemeToggle) {
      desktopThemeToggle.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === SITE_THEME.light ? SITE_THEME.dark : SITE_THEME.light;
        
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        
        updateDesktopThemeIcons(newTheme);
      });
    }
    
    // Banner Mode
    const bannerButtons = document.querySelectorAll("[data-set-banner-desktop]");
    const updateActiveBannerButton = () => {
      const currentMode = document.documentElement.getAttribute("data-banner-mode") || localStorage.getItem("banner-mode") || "normal";
      bannerButtons.forEach(btn => {
        if (btn.getAttribute("data-set-banner-desktop") === currentMode) {
          btn.classList.add("bg-primary/10", "text-primary", "font-bold", "active");
        } else {
          btn.classList.remove("bg-primary/10", "text-primary", "font-bold", "active");
        }
      });
    };

    updateActiveBannerButton();

    bannerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-set-banner-desktop");
        document.documentElement.setAttribute("data-banner-mode", mode);
        localStorage.setItem("banner-mode", mode);
        updateActiveBannerButton();
      });
    });

    // Desktop Settings Click Outside
    const dDetails = document.getElementById('desktop-settings-details');
    if (dDetails) {
        document.addEventListener('click', (e) => {
            if (dDetails.hasAttribute('open') && !dDetails.contains(e.target)) {
                dDetails.removeAttribute('open');
            }
        });
    }

    // Theme Selector Logic
    const themeButtons = document.querySelectorAll('[data-set-theme-desktop]');

    const updateActiveThemeButton = () => {
      const currentTheme = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme");
      themeButtons.forEach(btn => {
        if (btn.getAttribute('data-set-theme-desktop') === currentTheme) {
            btn.classList.add("bg-primary/10", "text-primary", "font-bold", "active");
        } else {
            btn.classList.remove("bg-primary/10", "text-primary", "font-bold", "active");
        }
      });
    };
    
    updateActiveThemeButton();
    
    themeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-set-theme-desktop');
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem('theme', theme);
        
        // Reset custom primary color when switching theme
        ['--p', '--s', '--a'].forEach(p => document.documentElement.style.removeProperty(p));
        localStorage.removeItem('custom-primary-hex');
        
        updateDesktopThemeIcons(theme);
        updateActiveThemeButton();
      });
    });

    // Anime Trace Logic
    const traceBtn = document.getElementById('animetrace-btn');
    const traceFile = document.getElementById('animetrace-file');
    const traceModel = document.getElementById('animetrace-model');
    const traceResult = document.getElementById('animetrace-result');

    if (traceBtn && traceFile) {
        traceBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const file = traceFile.files[0];
            if (!file) {
                alert('Please select an image first');
                return;
            }

            traceBtn.disabled = true;
            traceBtn.textContent = 'Searching...';
            traceResult.classList.remove('hidden');
            traceResult.textContent = 'Processing...';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('model', traceModel.value);
                formData.append('is_multi', '1');
                formData.append('ai_detect', '0'); // Optional

                const response = await fetch('https://api.animetrace.com/v1/search', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                let output = '';
                
                // 1. AI Status
                if (typeof data.ai !== 'undefined') {
                     output += `AI Generated: ${data.ai ? 'Yes' : 'No'}\n\n`;
                }

                // 2. Data loop
                if (data.data && Array.isArray(data.data)) {
                    data.data.forEach((item) => {
                         // API uses 'character' as the key for the list of matches
                         if (item.character && Array.isArray(item.character)) {
                             item.character.forEach(c => {
                                 output += `Work: ${c.work || 'Unknown'}\n`;
                                 output += `Character: ${c.character || 'Unknown'}\n\n`;
                             });
                         }
                    });
                }

                if (!output.trim()) {
                     output = 'No recognized data found.';
                }
                
                traceResult.textContent = output;
                console.log('AnimeTrace Data:', data); // Log to console as well

            } catch (e) {
                traceResult.textContent = 'Error: ' + e.message;
            } finally {
                traceBtn.disabled = false;
                traceBtn.textContent = 'Search';
            }
        });
    }



    // ========== Extra Features Logic ==========
    
    // Storage keys
    const STORAGE_SNOWFLAKES = 'extra-snowflakes';
    const STORAGE_FPS = 'extra-fps';
    const STORAGE_HEART = 'extra-heart';
    
    // Toggle elements
    const toggleSnowflakes = document.getElementById('toggle-snowflakes');
    const toggleFps = document.getElementById('toggle-fps');
    const toggleHeart = document.getElementById('toggle-heart');
    
    // ===== Snowflakes Feature =====
    // 使用 window 对象存储状态，确保页面切换时可以正确清理
    
    // 清理函数
    window.__snowflakesCleanup = function() {
        if (window.__snowflakesAnimationId) {
            clearInterval(window.__snowflakesAnimationId);
            window.__snowflakesAnimationId = null;
        }
        document.querySelectorAll('.snowflake').forEach(el => el.remove());
    };
    
    // 页面切换前清理雪花（使用 willReplaceContent 确保在替换前清理）
    if (!window.__snowflakesSwupBefore) {
        window.__snowflakesSwupBefore = function() {
            window.__snowflakesCleanup();
        };
        document.addEventListener('astro:before-swap', window.__snowflakesSwupBefore);
    }
    
    // 页面切换后重新启动雪花（如果启用）
    if (!window.__snowflakesSwupAfter) {
        window.__snowflakesSwupAfter = function() {
            if (localStorage.getItem('extra-snowflakes') === 'true') {
                setTimeout(() => {
                    if (!window.__snowflakesAnimationId) {
                        startSnowflakesGlobal();
                    }
                }, 300);
            }
        };
        document.addEventListener('astro:page-load', window.__snowflakesSwupAfter);
    }
    
    function startSnowflakesGlobal() {
        // 防止重复启动
        if (window.__snowflakesAnimationId) return;
        
        // Inject styles
        if (!document.getElementById('snowflakes-style')) {
            const styleEl = document.createElement('style');
            styleEl.id = 'snowflakes-style';
            styleEl.textContent = `
                .snowflake {
                    position: fixed;
                    color: #fff;
                    font-size: 1em;
                    top: -20px;
                    z-index: 99999;
                    pointer-events: none;
                    user-select: none;
                    text-shadow: 0 0 5px rgba(255,255,255,0.7);
                    animation: snowfall linear forwards;
                }
                @keyframes snowfall {
                    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                    100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
                }
            `;
            document.head.appendChild(styleEl);
        }
        
        const snowflakes = ['❄', '❅', '❆', '✻', '✼'];
        
        function createSnowflake() {
            // 如果页面不可见，不创建雪花
            if (document.hidden) return;
            
            const el = document.createElement('div');
            el.className = 'snowflake';
            el.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
            el.style.left = Math.random() * 100 + 'vw';
            el.style.fontSize = (Math.random() * 15 + 10) + 'px';
            el.style.animationDuration = (Math.random() * 5 + 5) + 's';
            el.style.opacity = Math.random() * 0.5 + 0.5;
            document.body.appendChild(el);
            
            el.addEventListener('animationend', () => el.remove());
        }
        
        // Create initial batch - 增加到25个
        for (let i = 0; i < 25; i++) {
            setTimeout(() => createSnowflake(), i * 150);
        }
        
        // Keep creating snowflakes - 更频繁
        window.__snowflakesAnimationId = setInterval(createSnowflake, 600);
    }
    
    // 处理页面可见性变化 - 防止后台积攒
    if (!window.__snowflakesVisibilityHandler) {
        window.__snowflakesVisibilityHandler = function() {
            if (document.hidden) {
                // 页面隐藏时清除现有雪花，防止积攒
                document.querySelectorAll('.snowflake').forEach(el => el.remove());
            }
        };
        document.addEventListener('visibilitychange', window.__snowflakesVisibilityHandler);
    }
    
    function stopSnowflakesGlobal() {
        window.__snowflakesCleanup();
    }
    
    // ===== FPS Counter Feature =====
    let fpsEl = null;
    let fpsStyleEl = null;
    let fpsRunning = false;
    let fpsFrames = 0;
    let fpsLastTime = 0;
    
    function startFps() {
        if (fpsRunning) return;
        fpsRunning = true;
        
        // Inject styles
        if (!document.getElementById('fps-style')) {
            fpsStyleEl = document.createElement('style');
            fpsStyleEl.id = 'fps-style';
            fpsStyleEl.textContent = `
                #fps-counter {
                    position: fixed;
                    top: 5px;
                    left: 8px;
                    z-index: 999999;
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 14px;
                    font-weight: bold;
                    color: #00ff00;
                    text-shadow: 1px 1px 2px #000000;
                    pointer-events: none;
                    user-select: none;
                }
            `;
            document.head.appendChild(fpsStyleEl);
        }
        
        // Create element
        if (!document.getElementById('fps-counter')) {
            fpsEl = document.createElement('div');
            fpsEl.id = 'fps-counter';
            fpsEl.textContent = 'FPS: --';
            document.body.appendChild(fpsEl);
        } else {
            fpsEl = document.getElementById('fps-counter');
        }
        
        fpsFrames = 0;
        fpsLastTime = performance.now();
        
        function fpsLoop() {
            if (!fpsRunning) return;
            const now = performance.now();
            fpsFrames++;
            if (now - fpsLastTime >= 1000) {
                const fps = Math.round((fpsFrames * 1000) / (now - fpsLastTime));
                if (fpsEl) fpsEl.textContent = 'FPS: ' + fps;
                fpsFrames = 0;
                fpsLastTime = now;
            }
            requestAnimationFrame(fpsLoop);
        }
        fpsLoop();
    }
    
    function stopFps() {
        fpsRunning = false;
        if (fpsEl) {
            fpsEl.remove();
            fpsEl = null;
        }
        if (fpsStyleEl) {
            fpsStyleEl.remove();
            fpsStyleEl = null;
        }
    }
    
    // ===== Heart Click Feature =====
    let heartStyleEl = null;
    let heartEnabled = false;
    let heartAnimationId = null;
    let hearts = [];
    
    function startHeart() {
        if (heartEnabled) return;
        heartEnabled = true;
        
        // Inject styles
        if (!document.getElementById('heart-style')) {
            heartStyleEl = document.createElement('style');
            heartStyleEl.id = 'heart-style';
            heartStyleEl.textContent = `
                .heart {
                    width: 10px;
                    height: 10px;
                    position: fixed;
                    background: #f00;
                    transform: rotate(45deg);
                    pointer-events: none;
                    z-index: 99999;
                }
                .heart:after, .heart:before {
                    content: '';
                    width: inherit;
                    height: inherit;
                    background: inherit;
                    border-radius: 50%;
                    position: fixed;
                }
                .heart:after { top: -5px; }
                .heart:before { left: -5px; }
            `;
            document.head.appendChild(heartStyleEl);
        }
        
        function getRandomColor() {
            return 'rgb(' + ~~(255 * Math.random()) + ',' + ~~(255 * Math.random()) + ',' + ~~(255 * Math.random()) + ')';
        }
        
        function heartLoop() {
            if (!heartEnabled) return;
            for (let i = 0; i < hearts.length; i++) {
                if (hearts[i].alpha <= 0) {
                    hearts[i].el.remove();
                    hearts.splice(i, 1);
                    i--;
                } else {
                    hearts[i].y--;
                    hearts[i].scale += 0.004;
                    hearts[i].alpha -= 0.013;
                    hearts[i].el.style.cssText = 
                        'left:' + hearts[i].x + 'px;' +
                        'top:' + hearts[i].y + 'px;' +
                        'opacity:' + hearts[i].alpha + ';' +
                        'transform:scale(' + hearts[i].scale + ',' + hearts[i].scale + ') rotate(45deg);' +
                        'background:' + hearts[i].color + ';' +
                        'z-index:99999;';
                }
            }
            heartAnimationId = requestAnimationFrame(heartLoop);
        }
        
        function createHeart(e) {
            if (!heartEnabled) return;
            const el = document.createElement('div');
            el.className = 'heart';
            hearts.push({
                el: el,
                x: e.clientX - 5,
                y: e.clientY - 5,
                scale: 1,
                alpha: 1,
                color: getRandomColor()
            });
            document.body.appendChild(el);
        }
        
        window.__heartClickHandler = createHeart;
        document.addEventListener('click', window.__heartClickHandler);
        heartLoop();
    }
    
    function stopHeart() {
        heartEnabled = false;
        if (heartAnimationId) {
            cancelAnimationFrame(heartAnimationId);
            heartAnimationId = null;
        }
        if (window.__heartClickHandler) {
            document.removeEventListener('click', window.__heartClickHandler);
            window.__heartClickHandler = null;
        }
        hearts.forEach(h => h.el.remove());
        hearts = [];
        if (heartStyleEl) {
            heartStyleEl.remove();
            heartStyleEl = null;
        }
    }
    
    // ===== Initialize Toggles =====
    if (toggleSnowflakes) {
        const savedSnow = localStorage.getItem(STORAGE_SNOWFLAKES) === 'true';
        toggleSnowflakes.checked = savedSnow;
        if (savedSnow) startSnowflakesGlobal();
        
        toggleSnowflakes.addEventListener('change', () => {
            const enabled = toggleSnowflakes.checked;
            localStorage.setItem(STORAGE_SNOWFLAKES, enabled);
            if (enabled) startSnowflakesGlobal();
            else stopSnowflakesGlobal();
        });
    }
    
    if (toggleFps) {
        const savedFps = localStorage.getItem(STORAGE_FPS) === 'true';
        toggleFps.checked = savedFps;
        if (savedFps) startFps();
        
        toggleFps.addEventListener('change', () => {
            const enabled = toggleFps.checked;
            localStorage.setItem(STORAGE_FPS, enabled);
            if (enabled) startFps();
            else stopFps();
        });
    }
    
    if (toggleHeart) {
        const savedHeart = localStorage.getItem(STORAGE_HEART) === 'true';
        toggleHeart.checked = savedHeart;
        if (savedHeart) startHeart();
        
        toggleHeart.addEventListener('change', () => {
            const enabled = toggleHeart.checked;
            localStorage.setItem(STORAGE_HEART, enabled);
            if (enabled) startHeart();
            else stopHeart();
        });
    }

    // ========== Site Info Logic ==========
    const GITHUB_REPO = 'flhcxcat/miuna-pic.github.io';
    const SITE_INFO_CACHE_KEY = 'site-info-cache';
    const SITE_INFO_CACHE_TTL = 300000; // 5 minutes

    const fetchSiteInfo = async () => {
        const lastUpdateEl = document.getElementById('site-last-update');
        const commitHashEl = document.getElementById('site-commit-hash');
        const actionsStatusEl = document.getElementById('site-actions-status');

        if (!lastUpdateEl || !commitHashEl || !actionsStatusEl) return;

        // Reset
        lastUpdateEl.textContent = '...';
        commitHashEl.textContent = '...';
        commitHashEl.href = '#';
        actionsStatusEl.textContent = '...';
        actionsStatusEl.className = 'text-xs font-mono';

        // Check cache
        const cachedStr = sessionStorage.getItem(SITE_INFO_CACHE_KEY);
        if (cachedStr) {
            try {
                const { data, timestamp } = JSON.parse(cachedStr);
                if (Date.now() - timestamp < SITE_INFO_CACHE_TTL) {
                    // Use cached data
                    lastUpdateEl.textContent = data.lastUpdate;
                    commitHashEl.textContent = data.commitHash;
                    commitHashEl.href = data.commitUrl;
                    actionsStatusEl.textContent = data.actionsStatus;
                    actionsStatusEl.className = 'text-xs font-mono ' + data.actionsClass;
                    return;
                }
            } catch (e) {
                // Cache parse error, continue to fetch
            }
        }

        try {
            // Fetch latest commit info
            const commitRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/commits?per_page=1`);
            const commits = await commitRes.json();
            
            if (commits && commits.length > 0) {
                const latestCommit = commits[0];
                const commitDate = new Date(latestCommit.commit.committer.date);
                const shortHash = latestCommit.sha.substring(0, 7);
                
                // Format date as relative time or short date
                const now = new Date();
                const diffMs = now - commitDate;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                let timeStr;
                if (diffHours < 1) {
                    timeStr = 'Just now';
                } else if (diffHours < 24) {
                    timeStr = `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    timeStr = `${diffDays}d ago`;
                } else {
                    timeStr = commitDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                lastUpdateEl.textContent = timeStr;
                lastUpdateEl.title = commitDate.toLocaleString();
                commitHashEl.textContent = shortHash;
                commitHashEl.href = latestCommit.html_url;
                commitHashEl.title = latestCommit.commit.message.split('\n')[0];
            } else {
                lastUpdateEl.textContent = 'N/A';
                commitHashEl.textContent = 'N/A';
            }
        } catch (e) {
            lastUpdateEl.textContent = 'Error';
            commitHashEl.textContent = 'Error';
        }

        // Fetch Actions status
        try {
            const runsRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/actions/runs?per_page=5`);
            const runsData = await runsRes.json();
            
            if (runsData && runsData.workflow_runs && runsData.workflow_runs.length > 0) {
                const runs = runsData.workflow_runs;
                
                // Check if any are in progress or queued
                const inProgress = runs.some(r => r.status === 'in_progress' || r.status === 'queued');
                const latestRun = runs[0];
                
                if (inProgress) {
                    actionsStatusEl.textContent = 'Running';
                    actionsStatusEl.classList.add('text-warning');
                } else if (latestRun.conclusion === 'success') {
                    actionsStatusEl.textContent = 'Passed';
                    actionsStatusEl.classList.add('text-success');
                } else if (latestRun.conclusion === 'failure') {
                    actionsStatusEl.textContent = 'Failed';
                    actionsStatusEl.classList.add('text-error');
                } else if (latestRun.conclusion === 'cancelled') {
                    actionsStatusEl.textContent = 'Cancelled';
                    actionsStatusEl.classList.add('text-warning');
                } else {
                    actionsStatusEl.textContent = latestRun.conclusion || 'Unknown';
                }
            } else {
                actionsStatusEl.textContent = 'No runs';
            }
        } catch (e) {
            actionsStatusEl.textContent = 'Error';
            actionsStatusEl.classList.add('text-error');
        }

        // Save to cache
        const cacheData = {
            lastUpdate: lastUpdateEl.textContent,
            commitHash: commitHashEl.textContent,
            commitUrl: commitHashEl.href,
            actionsStatus: actionsStatusEl.textContent,
            actionsClass: actionsStatusEl.className.replace('text-xs font-mono ', '')
        };
        sessionStorage.setItem(SITE_INFO_CACHE_KEY, JSON.stringify({
            data: cacheData,
            timestamp: Date.now()
        }));
    };

    const refreshSiteInfoBtn = document.getElementById('refresh-site-info');
    if (refreshSiteInfoBtn) {
        refreshSiteInfoBtn.addEventListener('click', () => {
            sessionStorage.removeItem(SITE_INFO_CACHE_KEY);
            fetchSiteInfo();
        });
    }
    
    // Auto-fetch on load
    fetchSiteInfo();

    // Observer for external changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes') {
          if (mutation.attributeName === 'data-theme') {
             updateActiveThemeButton();
             const currentTheme = document.documentElement.getAttribute("data-theme");
             updateDesktopThemeIcons(currentTheme);
          }
          if (mutation.attributeName === 'data-banner-mode') {
             updateActiveBannerButton();
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme', 'data-banner-mode']
    });
  });
</script>


