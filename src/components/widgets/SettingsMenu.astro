---
import { Icon } from "astro-icon/components";
import { SITE_THEME } from "@config";

const themes = [
  { name: "light", color: "#ffffff" },
  { name: "dark", color: "#1d232a" },
  { name: "cupcake", color: "#65c3c8" },
  { name: "bumblebee", color: "#e0a82e" },
  { name: "emerald", color: "#66cc8a" },
  { name: "corporate", color: "#4b6bfb" },
  { name: "synthwave", color: "#e779c1" },
  { name: "retro", color: "#ef9995" },
  { name: "cyberpunk", color: "#ff7598" },
  { name: "valentine", color: "#e96d7b" },
  { name: "halloween", color: "#f28c18" },
  { name: "garden", color: "#fe0075" },
  { name: "forest", color: "#1eb854" },
  { name: "aqua", color: "#09ecf3" },
  { name: "lofi", color: "#808080" },
  { name: "pastel", color: "#d1c1d7" },
  { name: "fantasy", color: "#6e0b75" },
  { name: "wireframe", color: "#b8b8b8" },
  { name: "black", color: "#000000" },
  { name: "luxury", color: "#ffffff" },
  { name: "dracula", color: "#ff79c6" },
  { name: "cmyk", color: "#45AEEE" },
  { name: "autumn", color: "#8C0327" },
  { name: "business", color: "#1C4E80" },
  { name: "acid", color: "#FF00F4" },
  { name: "lemonade", color: "#519903" },
  { name: "night", color: "#38bdf8" },
  { name: "coffee", color: "#DB924B" },
  { name: "winter", color: "#047AFF" },
];
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle hover:bg-white/10 text-primary" title="Settings">
    <Icon name="material-symbols:settings-outline" class="w-6 h-6" />
  </div>
  <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow-2xl bg-base-100 rounded-box w-64 mt-4 border border-base-200">
    <!-- Dark/Light Toggle -->
    <li>
      <button id="desktop-theme-toggle" class="flex justify-between items-center gap-2 p-2 hover:bg-base-200 rounded-lg w-full">
        <span class="font-medium">Dark/Light</span>
        <div class="btn btn-ghost btn-circle btn-sm text-primary hover:bg-primary/10 hover:scale-110 transition-all duration-300 pointer-events-none flex items-center justify-center">
          <Icon name="line-md:moon-alt-to-sunny-outline-loop-transition" class="w-5 h-5 light-icon" />
          <Icon name="line-md:sunny-outline-to-moon-alt-loop-transition" class="w-5 h-5 dark-icon hidden" />
        </div>
      </button>
    </li>

    <!-- Banner Mode Settings -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:image-outline" class="w-5 h-5" />
            Banner Mode
          </div>
        </summary>
        <ul class="p-2 bg-base-100 rounded-box">
          <li>
            <button data-set-banner-desktop="normal" class="flex gap-2">
              <Icon name="material-symbols:panorama-outline" class="w-5 h-5" />
              Normal
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="fullscreen" class="flex gap-2">
              <Icon name="material-symbols:fullscreen" class="w-5 h-5" />
              Fullscreen
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="background" class="flex gap-2">
              <Icon name="material-symbols:wallpaper" class="w-5 h-5" />
              Background
            </button>
          </li>
          <li>
            <button data-set-banner-desktop="hidden" class="flex gap-2">
              <Icon name="material-symbols:hide-image-outline" class="w-5 h-5" />
              Hidden
            </button>
          </li>
        </ul>
      </details>
    </li>

    <!-- Config Button -->
    <li>
      <a href="/config" class="flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
        <div class="flex items-center gap-2">
          <Icon name="material-symbols:settings-outline" class="w-5 h-5" />
          <span class="font-medium">Config</span>
        </div>
      </a>
    </li>

    <!-- Theme Selector -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:palette-outline" class="w-5 h-5" />
            Theme
          </div>
        </summary>
        <ul class="p-2 bg-base-100 rounded-box max-h-60 overflow-y-auto flex-nowrap">
          {themes.map((theme) => (
            <li>
              <button
                class="flex gap-3 items-center"
                data-set-theme-desktop={theme.name}
                aria-label={`Change theme to ${theme.name}`}
              >
                <span class="w-4 h-4 rounded-full border border-base-content/20" style={`background-color: ${theme.color};`}></span>
                <span class="capitalize">{theme.name}</span>
              </button>
            </li>
          ))}
        </ul>
      </details>
    </li>

    <!-- Custom Theme -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:format-paint" class="w-5 h-5" />
            Custom Theme
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Primary Color</span>
            <input type="color" id="custom-primary-picker" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent" />
          </div>
          <button id="reset-custom-theme" class="btn btn-xs btn-outline w-full mt-2">Reset to Preset</button>
        </div>
      </details>
    </li>

    <!-- Network Status -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:wifi" class="w-5 h-5" />
            Network Status
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2 cursor-default">
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">Ping</span>
            <span id="network-ping" class="text-xs font-bold font-mono">-- ms</span>
          </div>
          <div class="flex justify-between items-center px-1">
            <span class="text-sm">IP</span>
            <span id="network-ip" class="text-xs font-mono truncate max-w-[120px]">...</span>
          </div>
          <button id="refresh-network-status" class="btn btn-xs btn-outline w-full mt-1">Refresh</button>
        </div>
      </details>
    </li>

    <!-- Base64 Tool -->
    <li>
      <details>
        <summary class="font-medium flex justify-between items-center p-2 hover:bg-base-200 rounded-lg w-full">
          <div class="flex items-center gap-2">
            <Icon name="material-symbols:code" class="w-5 h-5" />
            Base64 Tool
          </div>
        </summary>
        <div class="p-2 bg-base-100 rounded-box flex flex-col gap-2">
          <textarea id="b64-input" class="textarea textarea-bordered textarea-xs w-full h-16 resize-none" placeholder="Input..."></textarea>
          <div class="grid grid-cols-2 gap-2">
            <button id="b64-encode-btn" class="btn btn-xs btn-primary">Encode</button>
            <button id="b64-decode-btn" class="btn btn-xs btn-secondary">Decode</button>
          </div>
          <div class="relative">
            <textarea id="b64-output" class="textarea textarea-bordered textarea-xs w-full h-16 resize-none font-mono" placeholder="Result..." readonly></textarea>
            <button id="b64-copy-btn" class="btn btn-xs btn-ghost btn-square absolute top-1 right-1" title="Copy">
               <Icon name="material-symbols:content-copy-outline" class="w-4 h-4" />
            </button>
          </div>
        </div>
      </details>
    </li>
  </ul>
</div>

<script is:inline define:vars={{ SITE_THEME }}>
  document.addEventListener("astro:page-load", () => {
    // ... (Existing Theme Helper & Color Logic)
    // Theme Helper
    const isDarkTheme = (theme) => ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee', 'dim', 'sunset'].includes(theme);

    // Base64 Logic
    const b64Input = document.getElementById('b64-input');
    const b64Output = document.getElementById('b64-output');
    const b64Encode = document.getElementById('b64-encode-btn');
    const b64Decode = document.getElementById('b64-decode-btn');
    const b64Copy = document.getElementById('b64-copy-btn');

    const utf8_to_b64 = (str) => {
        try {
            return window.btoa(unescape(encodeURIComponent(str)));
        } catch (e) {
            return "Error: Invalid Input";
        }
    };

    const b64_to_utf8 = (str) => {
        try {
            return decodeURIComponent(escape(window.atob(str)));
        } catch (e) {
            return "Error: Invalid Base64";
        }
    };

    if (b64Encode && b64Decode && b64Input && b64Output) {
        b64Encode.addEventListener('click', () => {
            b64Output.value = utf8_to_b64(b64Input.value);
        });

        b64Decode.addEventListener('click', () => {
            b64Output.value = b64_to_utf8(b64Input.value);
        });
        
        if (b64Copy) {
            b64Copy.addEventListener('click', () => {
                if (b64Output.value) {
                    navigator.clipboard.writeText(b64Output.value);
                    // Visual feedback could be added here
                    b64Copy.classList.add('text-success');
                    setTimeout(() => b64Copy.classList.remove('text-success'), 1000);
                }
            });
        }
    }

    // Network Status Logic
    const checkNetworkStatus = async () => {
        const pingEl = document.getElementById('network-ping');
        const ipEl = document.getElementById('network-ip');
        if (!pingEl || !ipEl) return;

        pingEl.textContent = 'Testing...';
        pingEl.className = 'text-xs font-bold font-mono'; // Reset color
        ipEl.textContent = 'Loading...';

        // Check Ping
        const start = performance.now();
        try {
            await fetch(window.location.href, { method: 'HEAD', cache: 'no-store' });
            const duration = Math.round(performance.now() - start);
            pingEl.textContent = `${duration} ms`;
            
            // Color Logic
            if (duration < 200) {
                pingEl.classList.add('text-success');
            } else if (duration < 500) {
                pingEl.classList.add('text-warning');
            } else {
                pingEl.classList.add('text-error');
            }
        } catch (e) {
            pingEl.textContent = 'Error';
            pingEl.classList.add('text-error');
        }

        // Check IP
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            ipEl.textContent = data.ip;
        } catch (e) {
            ipEl.textContent = 'Unknown';
        }
    };

    const refreshBtn = document.getElementById('refresh-network-status');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', checkNetworkStatus);
        // Initial check
        checkNetworkStatus();
    }

    // Color conversion helper (Hex to OKLCH approximation)
    // ... (rest of the script)
    // Since implementing full conversion is heavy, we will use a simplified approach
    // or rely on the fact that we can set hex if we don't strictly need OKLCH channels?
    // NO, global.scss uses `oklch(var(--p))`. We match that format.
    // Source: https://github.com/mina86/hex-to-oklch/ (simplified)
    // Actually, we can use a simpler sRGB to Linear to OKLCH flow.
    
    function hexToRgb(hex) {
       const bigint = parseInt(hex.slice(1), 16);
       const r = (bigint >> 16) & 255;
       const g = (bigint >> 8) & 255;
       const b = bigint & 255;
       return [r / 255, g / 255, b / 255];
    }

    function srgbTransfer(v) {
        return v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    }
    
    function rgbToOklch(r, g, b) {
        const lr = srgbTransfer(r);
        const lg = srgbTransfer(g);
        const lb = srgbTransfer(b);
        
        const l = 0.4122214708 * lr + 0.5363325363 * lg + 0.0514459929 * lb;
        const m = 0.2119034982 * lr + 0.6806995451 * lg + 0.1073969566 * lb;
        const s = 0.0883024619 * lr + 0.2817188376 * lg + 0.6302787005 * lb;
        
        const l_ = Math.cbrt(l);
        const m_ = Math.cbrt(m);
        const s_ = Math.cbrt(s);
        
        const L = 0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_;
        const a = 1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_;
        const b_ = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_;
        
        const C = Math.sqrt(a * a + b_ * b_);
        let H = Math.atan2(b_, a) * 180 / Math.PI;
        if (H < 0) H += 360;
        
        // Return format for CSS [L C H]
        // Truncate decimals to save space
        return `${L.toFixed(3)} ${C.toFixed(3)} ${H.toFixed(3)}`;
    }

    function updateCustomColor(hex) {
        const [r, g, b] = hexToRgb(hex);
        const oklch = rgbToOklch(r, g, b);
        document.documentElement.style.setProperty('--p', oklch);
        document.documentElement.style.setProperty('--s', oklch); // Set secondary too?
        document.documentElement.style.setProperty('--a', oklch); // Set accent too?
        // Usually Primary is enough.
        localStorage.setItem('custom-primary-hex', hex);
    }

    // Initialize Custom Color
    const storedCustomHex = localStorage.getItem('custom-primary-hex');
    const colorPicker = document.getElementById('custom-primary-picker');
    if (storedCustomHex && colorPicker) {
        colorPicker.value = storedCustomHex;
        updateCustomColor(storedCustomHex);
    }

    if (colorPicker) {
        colorPicker.addEventListener('input', (e) => {
            updateCustomColor(e.target.value);
        });
    }
    
    // Reset Logic
    const resetButton = document.getElementById('reset-custom-theme');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            document.documentElement.style.removeProperty('--p');
            document.documentElement.style.removeProperty('--s');
            document.documentElement.style.removeProperty('--a');
            localStorage.removeItem('custom-primary-hex');
        });
    }

    // Dark/Light Toggle Logic
    const desktopThemeToggle = document.getElementById("desktop-theme-toggle");
    
    const updateDesktopThemeIcons = (theme) => {
      // ... same as before
      const isDark = isDarkTheme(theme);
      
      // Update attribute
      document.documentElement.setAttribute('data-theme-type', isDark ? 'dark' : 'light');

      if (!desktopThemeToggle) return;
      const lightIcon = desktopThemeToggle.querySelector(".light-icon");
      const darkIcon = desktopThemeToggle.querySelector(".dark-icon");
      
      if (lightIcon && darkIcon) {
        if (isDark) {
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }
    };

    // Initialize icon state
    const currentTheme = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme");
    updateDesktopThemeIcons(currentTheme);

    if (desktopThemeToggle) {
      desktopThemeToggle.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === SITE_THEME.light ? SITE_THEME.dark : SITE_THEME.light;
        
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        
        updateDesktopThemeIcons(newTheme);
      });
    }
    
    // ... Banner Mode (same) ...
    // Banner Mode Logic
    const bannerButtons = document.querySelectorAll("[data-set-banner-desktop]");
    
    // ...
    const updateActiveBannerButton = () => {
      const currentMode = document.documentElement.getAttribute("data-banner-mode") || localStorage.getItem("banner-mode") || "normal";
      bannerButtons.forEach(btn => {
        if (btn.getAttribute("data-set-banner-desktop") === currentMode) {
          btn.classList.add("bg-primary/10", "text-primary", "font-bold", "active");
        } else {
          btn.classList.remove("bg-primary/10", "text-primary", "font-bold", "active");
        }
      });
    };

    updateActiveBannerButton();

    bannerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-set-banner-desktop");
        document.documentElement.setAttribute("data-banner-mode", mode);
        localStorage.setItem("banner-mode", mode);
        updateActiveBannerButton();
      });
    });

    // Theme Selector Logic
    const themeButtons = document.querySelectorAll('[data-set-theme-desktop]');

    const updateActiveThemeButton = () => {
      const currentTheme = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme");
      themeButtons.forEach(btn => {
        if (btn.getAttribute('data-set-theme-desktop') === currentTheme) {
            btn.classList.add("bg-primary/10", "text-primary", "font-bold", "active");
        } else {
            btn.classList.remove("bg-primary/10", "text-primary", "font-bold", "active");
        }
      });
    };
    
    updateActiveThemeButton();
    
    themeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-set-theme-desktop');
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem('theme', theme);
        
        // Remove Custom Color when switching theme?
        document.documentElement.style.removeProperty('--p');
        document.documentElement.style.removeProperty('--s');
        document.documentElement.style.removeProperty('--a');
        localStorage.removeItem('custom-primary-hex');
        // Reset picker value if possible?
        
        updateDesktopThemeIcons(theme);
        updateActiveThemeButton();
      });
    });

    // Observer for external changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes') {
          if (mutation.attributeName === 'data-theme') {
             updateActiveThemeButton();
             const currentTheme = document.documentElement.getAttribute("data-theme");
             updateDesktopThemeIcons(currentTheme);
          }
          if (mutation.attributeName === 'data-banner-mode') {
             updateActiveBannerButton();
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme', 'data-banner-mode']
    });
  });
</script>
