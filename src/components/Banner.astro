---
import {
  BANNER_HEIGHT,
  SITE_PAGES,
  TYPEWRITER_TEXTS,
} from "@config";

// 统一所有页面都只用配置文件 SITE_PAGES
const currentPath = Astro.url.pathname;
let pageKey = "home";
if (currentPath === "/") {
  pageKey = "home";
} else if (currentPath === "/about") {
  pageKey = "about";
} else if (
  currentPath.startsWith("/blog/") &&
  !currentPath.includes("/blog/page/") &&
  currentPath !== "/blog" &&
  !currentPath.includes("/blog/tag/") &&
  !currentPath.includes("/blog/category/")
) {
  pageKey = "home"; // 博客详情页也用 home 配置
} else if (currentPath.startsWith("/navigation/") || currentPath === "/navigation") {
  pageKey = "navigation";
} else {
  // 其它页面如 /anime、/friend、/project、/navigation 等
  pageKey = currentPath.replace(/^\//, "");
}

const cleanPageKey = pageKey.replace(/\/$/, "");
const pageConfig =
  SITE_PAGES[cleanPageKey] ?? SITE_PAGES[pageKey] ?? SITE_PAGES["home"];
// 所有页面都使用大字体
const useLargeFont = true;
// 所有页面的副标题都使用一言打字机效果
const useTypewriter = true;
const displayTitle = pageConfig.title || "";
const displaySubtitle = pageConfig.subtitle || "";
const hasTitle = displayTitle !== undefined && displayTitle !== "";
const hasSubtitle = displaySubtitle !== undefined && displaySubtitle !== "";

const bannerHeight = BANNER_HEIGHT;

// 随机图 API 配置
const RANDOM_API_URL = "https://pic.000.moe/random";
// 首屏图片：服务端生成一个随机种子，确保每次刷新（或构建）时有一张初始图
const initialRandomImage = `${RANDOM_API_URL}?t=${Date.now()}`;
---

<div id="banner" class="banner">
  <div class="banner-inner h-full w-full relative overflow-hidden">
    <!-- 背景层：当前显示的图片 -->
    <div 
      id="banner-bg-current"
      class="absolute left-0 top-0 h-full w-full bg-cover bg-top md:bg-center bg-no-repeat z-0 transition-opacity duration-1000"
      style={{ backgroundImage: `url(${initialRandomImage})` }}
    ></div>

    <!-- 背景层：下一张预加载的图片 (初始隐藏) -->
    <div 
      id="banner-bg-next"
      class="absolute left-0 top-0 h-full w-full bg-cover bg-top md:bg-center bg-no-repeat z-0 opacity-0 transition-opacity duration-1000"
    ></div>

    <!-- 遮罩层 -->
    <div class="absolute left-0 top-0 z-10 h-full w-full transition-colors duration-300 bg-black/40"></div>

    <!-- 显示标题和副标题 -->
    {
      (hasTitle || hasSubtitle) && (
        <div class="relative z-20 h-[95%] w-full pointer-events-none">
          <div class="absolute left-1/2 top-1/2 w-4/5 -translate-x-1/2 -translate-y-1/2 lg:w-3/4">
            <div class="flex flex-col pointer-events-auto" id="banner-text-container">
              {hasTitle && (
                <div
                  class={`title font-banner ${useLargeFont ? "text-4xl md:text-6xl lg:text-8xl" : "text-3xl md:text-4xl lg:text-6xl"}`}
                  data-pagefind-ignore
                >
                  {displayTitle}
                </div>
              )}
              {hasSubtitle && (
                <div
                  class={`subtitle font-banner ${useLargeFont ? "text-xl md:text-2xl lg:text-4xl" : "text-base md:text-lg lg:text-2xl"}`}
                  data-pagefind-ignore
                >
                  {useTypewriter ? (
                    <span id="typewriter-text" data-pagefind-ignore>{displaySubtitle}</span>
                  ) : (
                    displaySubtitle
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )
    }
  </div>

  <!-- 波浪动画效果 -->
  <div class="waves">
    <svg
      class="waves"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 24 150 28"
      preserveAspectRatio="none"
      shape-rendering="auto"
    >
      <defs>
        <path
          id="gentle-wave"
          d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"
        ></path>
      </defs>
      <g class="parallax">
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="0"
          class="opacity-25"
          style={{ animationDelay: "-2s", animationDuration: "7s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="3"
          class="opacity-50"
          style={{ animationDelay: "-3s", animationDuration: "10s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="5"
          class="opacity-75"
          style={{ animationDelay: "-4s", animationDuration: "13s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="7"
          style={{ animationDelay: "-5s", animationDuration: "20s" }}></use>
      </g>
    </svg>
  </div>
</div>


<!-- 数据配置容器 -->
<div 
  id="banner-data" 
  data-texts={JSON.stringify(TYPEWRITER_TEXTS)} 
  data-typewriter={useTypewriter.toString()}
  data-api={RANDOM_API_URL}
  hidden
></div>

<script is:inline>
  (function() {
    // 使用 window 全局存储，确保页面切换时能正确清理
    window.__hitokotoTimer = window.__hitokotoTimer || null;
    
    // 清理函数
    var cleanupTypewriter = function() {
      if (window.__hitokotoTimer) {
        clearTimeout(window.__hitokotoTimer);
        window.__hitokotoTimer = null;
      }
    };

    var initBanner = function() {
      // 先清理之前的定时器
      cleanupTypewriter();
      
      var dataEl = document.getElementById("banner-data");
      if (!dataEl) return;

      var enabled = dataEl.getAttribute("data-typewriter") === "true";

      // 1. 打字机效果 - 使用一言API
      if (enabled) {
        var bannerSubtitle = document.getElementById("typewriter-text");
        if (bannerSubtitle) {
          var currentText = "";
          var charIndex = 0;
          var isDeleting = false;
          
          // 从一言API获取新句子
          var fetchHitokoto = function(callback) {
            fetch("https://v1.hitokoto.cn/")
              .then(function(res) { return res.json(); })
              .then(function(data) {
                callback(data.hitokoto || "欢迎来到我的博客");
              })
              .catch(function() {
                callback("欢迎来到我的博客");
              });
          };

          var type = function() {
            var el = document.getElementById("typewriter-text");
            if (!el) {
              cleanupTypewriter();
              return;
            }

            if (isDeleting) {
              el.textContent = currentText.substring(0, charIndex - 1);
              charIndex--;
            } else {
              el.textContent = currentText.substring(0, charIndex + 1);
              charIndex++;
            }

            var typeSpeed = isDeleting ? 50 : 100;
            if (!isDeleting && charIndex === currentText.length) {
              isDeleting = true;
              typeSpeed = 2000;
            } else if (isDeleting && charIndex === 0) {
              isDeleting = false;
              // 删除完成后获取新句子
              fetchHitokoto(function(text) {
                currentText = text;
                typeSpeed = 500;
                window.__hitokotoTimer = setTimeout(type, typeSpeed);
              });
              return;
            }
            window.__hitokotoTimer = setTimeout(type, typeSpeed);
          };

          // 初始化：获取第一条一言
          fetchHitokoto(function(text) {
            currentText = text;
            type();
          });
        }
      }

      // 2. 背景切换逻辑 (这里只处理初始化)
      var bgCurrent = document.getElementById("banner-bg-current");
      if (bgCurrent && bgCurrent.style.backgroundImage) {
        document.documentElement.style.setProperty('--banner-image-url', bgCurrent.style.backgroundImage);
      }
    };

    // 初始加载
    if (document.readyState === 'loading') {
      document.addEventListener("DOMContentLoaded", initBanner);
    } else {
      initBanner();
    }
    
    // 防止重复注册事件监听器
    if (!window.__bannerSwupListenersRegistered) {
      window.__bannerSwupListenersRegistered = true;
      // swup 页面切换前清理
      document.addEventListener("swup:willReplaceContent", cleanupTypewriter);
      // swup 页面切换后重新初始化
      document.addEventListener("swup:contentReplaced", initBanner);
    }
  })();
</script>

<style define:vars={{ bannerHeight }}>
  .banner {
    @apply relative opacity-100;
    height: 40vh;
  }

  @media (min-width: 768px) {
    .banner {
      height: var(--bannerHeight);
    }
  }

  .title {
    @apply mt-8 text-center font-bold drop-shadow-lg lg:mt-1 text-white;
    font-family: var(--title-font);
    line-height: 1.3;
  }

  .subtitle {
    @apply text-center drop-shadow-md text-white;
    font-family: var(--subtitle-font);
    white-space: pre-line;
    line-height: 1.3;
  }

  .waves {
    @apply absolute -bottom-[1px] h-[10vh] max-h-[9.375rem] min-h-[3.125rem] w-full z-10;
    @apply md:h-[15vh];
  }

  .waves > .parallax use {
    fill: var(--banner-wave-bg);
    animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
  }

  @keyframes wave {
    0% {
      transform: translate3d(-90px, 0, 0);
    }
    100% {
      transform: translate3d(85px, 0, 0);
    }
  }
</style>
