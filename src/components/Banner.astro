---
import {
  BANNER_HEIGHT,
  SITE_PAGES,
  TYPEWRITER_TEXTS,
} from "@config";

// ç»Ÿä¸€æ‰€æœ‰é¡µé¢éƒ½åªç”¨é…ç½®æ–‡ä»¶ SITE_PAGES
const currentPath = Astro.url.pathname;
let pageKey = "home";
if (currentPath === "/") {
  pageKey = "home";
} else if (currentPath === "/about") {
  pageKey = "about";
} else if (
  currentPath.startsWith("/blog/") &&
  !currentPath.includes("/blog/page/") &&
  currentPath !== "/blog" &&
  !currentPath.includes("/blog/tag/") &&
  !currentPath.includes("/blog/category/")
) {
  pageKey = "home"; // åšå®¢è¯¦æƒ…é¡µä¹Ÿç”¨ home é…ç½®
} else if (currentPath.startsWith("/navigation/") || currentPath === "/navigation") {
  pageKey = "navigation";
} else {
  // å…¶å®ƒé¡µé¢å¦‚ /animeã€/friendã€/projectã€/navigation ç­‰
  pageKey = currentPath.replace(/^\//, "");
}

const cleanPageKey = pageKey.replace(/\/$/, "");
const pageConfig =
  SITE_PAGES[cleanPageKey] ?? SITE_PAGES[pageKey] ?? SITE_PAGES["home"];
const useLargeFont =
  pageKey === "home" ||
  (currentPath.startsWith("/blog/") &&
    !currentPath.includes("/blog/page/") &&
    currentPath !== "/blog" &&
    !currentPath.includes("/blog/tag/") &&
    !currentPath.includes("/blog/category/"));
const useTypewriter = currentPath === "/";
const displayTitle = pageConfig.title || "";
const displaySubtitle = pageConfig.subtitle || "";
const hasTitle = displayTitle !== undefined && displayTitle !== "";
const hasSubtitle = displaySubtitle !== undefined && displaySubtitle !== "";

const bannerHeight = BANNER_HEIGHT;

// éšæœºå›¾ API é…ç½®
const RANDOM_API_URL = "https://pic.000.moe/random";
// é¦–å±å›¾ç‰‡ï¼šæœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºç§å­ï¼Œç¡®ä¿æ¯æ¬¡åˆ·æ–°ï¼ˆæˆ–æ„å»ºï¼‰æ—¶æœ‰ä¸€å¼ åˆå§‹å›¾
const initialRandomImage = `${RANDOM_API_URL}?t=${Date.now()}`;
---

<div id="banner" class="banner">
  <div class="banner-inner h-full w-full relative overflow-hidden">
    <!-- èƒŒæ™¯å±‚ï¼šå½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ -->
    <div 
      id="banner-bg-current"
      class="absolute left-0 top-0 h-full w-full bg-cover bg-top md:bg-center bg-no-repeat z-0 transition-opacity duration-1000"
      style={{ backgroundImage: `url(${initialRandomImage})` }}
    ></div>

    <!-- èƒŒæ™¯å±‚ï¼šä¸‹ä¸€å¼ é¢„åŠ è½½çš„å›¾ç‰‡ (åˆå§‹éšè—) -->
    <div 
      id="banner-bg-next"
      class="absolute left-0 top-0 h-full w-full bg-cover bg-top md:bg-center bg-no-repeat z-0 opacity-0 transition-opacity duration-1000"
    ></div>

    <!-- é®ç½©å±‚ -->
    <div class="absolute left-0 top-0 z-10 h-full w-full transition-colors duration-300 bg-black/40"></div>

    <!-- æ˜¾ç¤ºæ ‡é¢˜å’Œå‰¯æ ‡é¢˜ -->
    {
      (hasTitle || hasSubtitle) && (
        <div class="relative z-20 h-[95%] w-full pointer-events-none">
          <div class="absolute left-1/2 top-1/2 w-4/5 -translate-x-1/2 -translate-y-1/2 lg:w-3/4">
            <div class="flex flex-col pointer-events-auto" id="banner-text-container">
              {hasTitle && (
                <div
                  class={`title font-banner ${useLargeFont ? "text-4xl md:text-6xl lg:text-8xl" : "text-3xl md:text-4xl lg:text-6xl"}`}
                  data-pagefind-ignore
                >
                  {displayTitle}
                </div>
              )}
              {hasSubtitle && (
                <div
                  class={`subtitle font-banner ${useLargeFont ? "text-xl md:text-2xl lg:text-4xl" : "text-base md:text-lg lg:text-2xl"}`}
                  data-pagefind-ignore
                >
                  {useTypewriter ? (
                    <span id="typewriter-text" data-pagefind-ignore>{displaySubtitle}</span>
                  ) : (
                    displaySubtitle
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )
    }
  </div>

  <!-- æ³¢æµªåŠ¨ç”»æ•ˆæœ -->
  <div class="waves">
    <svg
      class="waves"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 24 150 28"
      preserveAspectRatio="none"
      shape-rendering="auto"
    >
      <defs>
        <path
          id="gentle-wave"
          d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"
        ></path>
      </defs>
      <g class="parallax">
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="0"
          class="opacity-25"
          style={{ animationDelay: "-2s", animationDuration: "7s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="3"
          class="opacity-50"
          style={{ animationDelay: "-3s", animationDuration: "10s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="5"
          class="opacity-75"
          style={{ animationDelay: "-4s", animationDuration: "13s" }}></use>
        <use
          xlink:href="#gentle-wave"
          x="48"
          y="7"
          style={{ animationDelay: "-5s", animationDuration: "20s" }}></use>
      </g>
    </svg>
  </div>
</div>


<!-- æ•°æ®é…ç½®å®¹å™¨ -->
<div 
  id="banner-data" 
  data-texts={JSON.stringify(TYPEWRITER_TEXTS)} 
  data-typewriter={useTypewriter.toString()}
  data-api={RANDOM_API_URL}
  hidden
></div>

<script is:inline>
  (function() {
    // ä½¿ç”¨å‘½åç©ºé—´ä¿æŠ¤
    if (window.__BANNER_INIT__) return;
    window.__BANNER_INIT__ = true;

    var initBanner = function() {
      var dataEl = document.getElementById("banner-data");
      if (!dataEl) return;

      var texts = JSON.parse(dataEl.getAttribute("data-texts") || "[]");
      var enabled = dataEl.getAttribute("data-typewriter") === "true";

      // 1. æ‰“å­—æœºæ•ˆæœ
      if (enabled && texts.length > 0) {
        var bannerSubtitle = document.getElementById("typewriter-text");
        if (bannerSubtitle) {
          var textIndex = 0;
          var charIndex = 0;
          var isDeleting = false;
          
          var type = function() {
            // é‡æ–°è·å–å…ƒç´ ï¼Œé˜²æ­¢ DOM å·²æ›´æ–°
            var el = document.getElementById("typewriter-text");
            if (!el || window.__BANNER_BUG_TRIGGERED__) return;

            var currentText = texts[textIndex] || "";
            if (isDeleting) {
              el.textContent = currentText.substring(0, charIndex - 1);
              charIndex--;
            } else {
              el.textContent = currentText.substring(0, charIndex + 1);
              charIndex++;
            }

            var typeSpeed = isDeleting ? 50 : 100;
            if (!isDeleting && charIndex === currentText.length) {
              isDeleting = true;
              typeSpeed = 2000;
            } else if (isDeleting && charIndex === 0) {
              isDeleting = false;
              textIndex = (textIndex + 1) % texts.length;
              typeSpeed = 500;
            }
            setTimeout(type, typeSpeed);
          };
          type();
        }
      }

      // 3. å¤æ´»èŠ‚å½©è›‹ï¼šç‚¹å‡»ä¸»é¡µ10æ¬¡è§¦å‘
      var clickCount = 0;
      var lastClickTime = 0;
      var easterEggTriggered = false;

      var handleHomeClick = function() {
        // åªæœ‰åœ¨ä¸»é¡µç‚¹å‡»æ‰è®¡æ•°
        if (window.location.pathname !== '/') return;
        
        var now = Date.now();
        // 2ç§’å†…è¿ç»­ç‚¹å‡»
        if (now - lastClickTime < 2000) {
          clickCount++;
        } else {
          clickCount = 1;
        }
        lastClickTime = now;

        if (clickCount >= 10 && !easterEggTriggered) {
          easterEggTriggered = true;
          var container = document.getElementById("banner-text-container");
          if (container) {
            container.innerHTML = '<div class="title font-banner text-4xl md:text-6xl lg:text-8xl animate-bounce text-white text-center">ğŸ›ä½ æ‰åˆ°äº†Bug</div>';
            // åŒæ—¶æ¸…ç†æ‰“å­—æœºå®šæ—¶å™¨ï¼ˆé€šè¿‡åˆ é™¤ ID å…ƒç´ å·²é—´æ¥å®ç°ï¼Œä½†è¿™é‡Œæ˜ç¡®æ ‡è®°ï¼‰
            window.__BANNER_BUG_TRIGGERED__ = true;
          }
        }
      };

      // ä¸ºæ‰€æœ‰ä¸»é¡µé“¾æ¥æ·»åŠ ç›‘å¬
      document.querySelectorAll('a[href="/"]').forEach(function(link) {
        link.addEventListener('click', handleHomeClick);
      });

      // 2. èƒŒæ™¯åˆ‡æ¢é€»è¾‘ (è¿™é‡Œåªå¤„ç†åˆå§‹åŒ–)
      var bgCurrent = document.getElementById("banner-bg-current");
      if (bgCurrent && bgCurrent.style.backgroundImage) {
        document.documentElement.style.setProperty('--banner-image-url', bgCurrent.style.backgroundImage);
      }
    };

    document.addEventListener("astro:page-load", initBanner);
  })();
</script>

<style define:vars={{ bannerHeight }}>
  .banner {
    @apply relative opacity-100;
    height: 40vh;
  }

  @media (min-width: 768px) {
    .banner {
      height: var(--bannerHeight);
    }
  }

  .title {
    @apply mt-8 text-center font-bold drop-shadow-lg lg:mt-1 text-white;
    font-family: var(--title-font);
    line-height: 1.3;
  }

  .subtitle {
    @apply text-center drop-shadow-md text-white;
    font-family: var(--subtitle-font);
    white-space: pre-line;
    line-height: 1.3;
  }

  .waves {
    @apply absolute -bottom-[1px] h-[10vh] max-h-[9.375rem] min-h-[3.125rem] w-full z-10;
    @apply md:h-[15vh];
  }

  .waves > .parallax use {
    fill: var(--banner-wave-bg);
    animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
  }

  @keyframes wave {
    0% {
      transform: translate3d(-90px, 0, 0);
    }
    100% {
      transform: translate3d(85px, 0, 0);
    }
  }
</style>
