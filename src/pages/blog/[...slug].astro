---
import BaseLayout from "@layouts/BaseLayout.astro";
import License from "@components/widgets/License.astro";
import PostInfo from "@components/widgets/PostInfo.astro";
import PostFilter from "@components/widgets/PostFilter.astro";
import PostNavigation from "@components/widgets/PostNavigation.astro";
import { type CollectionEntry, getCollection } from "astro:content";
import dayjs from "@utils/dayjs";
import { DATE_FORMAT } from "@config";
import MainCard from "@/components/MainCard.astro";
import Twikoo from "@components/comments/Twikoo.astro";
import { commentsConfig } from "@config";
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  // 过滤草稿并按发布日期排序
  const publishedPosts = posts
    .filter((post) => !post.data.draft)
    .sort(
      (a, b) =>
        new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
    );

  return publishedPosts.map((blog, index) => {
    const prevPost =
      index < publishedPosts.length - 1 ? publishedPosts[index + 1] : null;
    const nextPost = index > 0 ? publishedPosts[index - 1] : null;

    return {
      params: { slug: blog.slug },
      props: { blog, prevPost, nextPost },
    };
  });
}

interface Props {
  blog: CollectionEntry<"blog">;
  prevPost?: CollectionEntry<"blog">;
  nextPost?: CollectionEntry<"blog">;
}

const { blog, prevPost, nextPost } = Astro.props;
const { Content, remarkPluginFrontmatter, headings } = await blog.render();
const displayDate = blog.data.pubDate
  ? dayjs(blog.data.pubDate).format(DATE_FORMAT)
  : "";
const url = new URL(`/blog/${blog.slug}`, Astro.url.origin);
---

<BaseLayout
  title={blog.data.title}
  image={blog.data.image}
  headings={headings}
  showTOC={true}
  isPostPage={true}
>
  <MainCard
    title={blog.data.title}
    description={blog.data.description}
    image={blog.data.image}
    infoIcon="lucide:info"
  >
    <div class="flex justify-end">
      <a href={`/write?slug=${blog.slug}`} class="btn btn-primary btn-sm text-white" aria-label="Edit Article">
        <Icon name="lucide:edit" class="w-4 h-4" />
        <span class="hidden sm:inline">Edit</span>
      </a>
    </div>
    <!-- Article info using PostInfo component -->
    <PostInfo
      pubDate={displayDate}
      badge={blog.data.badge}
      word={remarkPluginFrontmatter.totalCharCount}
      time={remarkPluginFrontmatter.readingTime}
      url={`/blog/${blog.slug}`}
      hideViews={true}
    />

    <!-- Categories and tags using PostFilter component -->
    <div class="mb-6">
      <PostFilter categories={blog.data.categories} tags={blog.data.tags} />
    </div>

    <!-- Article Content -->
    <div class="mt-8">
      <div
        id="content"
        class="prose md:prose-lg prose-code:text-base max-w-none text-justify prose-headings:scroll-mt-20 prose-img:rounded-2xl prose-img:mx-auto prose-img:cursor-pointer"
      >
        <Content />
        <License
          url={url.toString()}
          title={blog.data.title}
          description={blog.data.description}
          image={blog.data.image}
          pubDate={blog.data.pubDate}
          badge={blog.data.badge}
          categories={blog.data.categories}
          tags={blog.data.tags}
          word={remarkPluginFrontmatter.totalCharCount}
          time={remarkPluginFrontmatter.readingTime}
        />
      </div>
      </div>
    </div>
    <!-- 添加文章导航 -->
    <PostNavigation prevPost={prevPost} nextPost={nextPost} />
  </MainCard>

  {
    commentsConfig?.enable &&
      commentsConfig.type === "twikoo" &&
      commentsConfig.twikoo && (
        <section class="comments">

          <Twikoo {...commentsConfig.twikoo} />
        </section>
      )
  }

  <!-- 在页面底部添加 Fancybox 初始化脚本 -->
  <script>
    import { Fancybox } from "@fancyapps/ui";

    document.addEventListener("astro:page-load", () => {
      const images = document.querySelectorAll("#content img");
      
      images.forEach((img) => {
        // 如果图片已经在链接中，则跳过
        if (img.closest("a")) return;
        // 如果图片有 no-fancybox 类，则跳过
        if (img.classList.contains("no-fancybox")) return;

        
        const link = document.createElement("a");
        link.href = (img as HTMLImageElement).src;
        link.dataset.fancybox = "gallery";
        link.dataset.caption = (img as HTMLImageElement).alt || "";
        
        if (img.parentNode) {
          img.parentNode.insertBefore(link, img);
          link.appendChild(img);
        }
      });

      Fancybox.bind("[data-fancybox]", {
        // 可以在这里配置 Fancybox 选项
        Toolbar: {
          display: {
            left: ["infobar"],
            middle: [
              "zoomIn",
              "zoomOut",
              "toggle1to1",
              "rotateCCW",
              "rotateCW",
              "flipX",
              "flipY",
            ],
            right: ["slideshow", "thumbs", "close"],
          },
        },
      } as any);
    });
  </script>
</BaseLayout>
