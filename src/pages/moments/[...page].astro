---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import MomentsEditor from "@/components/MomentsEditor";
import MomentDeleteButton from "@/components/MomentDeleteButton";
import momentsData from "@/data/moments.json";

// HTML escape function to prevent compression errors
function escapeHtml(text: string): string {
  const map: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Get pagination from "@/components/widgets/Pagination.astro";
import Pagination from "@/components/widgets/Pagination.astro";
import { generatePageLinks } from "@utils/blogUtils";
import Card from "@/components/temple/Card.astro";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import timezone from "dayjs/plugin/timezone";

(dayjs as any).extend(utc);
(dayjs as any).extend(timezone);
import { marked } from "marked";
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import { getSteamGameInfo, extractSteamAppId } from "@utils/steamApi";
import { getBangumiSubject, extractBangumiId } from "@utils/bangumiApi";
import { getNeteaseSongInfo, extractNeteaseSongId, formatDuration } from "@utils/neteaseApi";
import { getBilibiliVideoInfo, extractBilibiliVideoId, formatViewCount, formatVideoDuration } from "@utils/bilibiliApi";
import { getGitHubRepoInfo, extractGitHubRepo, formatGitHubCount, getLanguageColor } from "@utils/githubApi";
import { getTMDBMovieInfo, getTMDBTVInfo, extractTMDBId, getTMDBImageUrl, formatTMDBRating, formatRuntime } from "@utils/tmdbApi";
import { getYouTubeVideoInfo, extractYouTubeVideoId, formatYouTubeCount, parseYouTubeDuration, getYouTubeThumbnail } from "@utils/youtubeApi";
import { getTikTokVideoInfo, extractTikTokId } from "@utils/tiktokApi";
import { getVNDBInfo, extractVNDBId, formatVNDBRating, getVNDBLengthLabel } from "@utils/vndbApi";

import type { Page } from "astro";

interface Moment {
  id: string;
  content: string;
  images: string[];
  createdAt: string;
  tags: string[];
}

interface Props {
  page: Page<Moment>;
}

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const sortedMoments = momentsData.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
  return paginate(sortedMoments, { pageSize: 6 });
}

const { page } = Astro.props as Props;
const totalPages = Math.ceil(page.total / page.size);
const pageLinks = generatePageLinks(totalPages);

async function renderContent(content: string, momentId: string) {
  // First replace Steam links with placeholders and collect them
  const steamLinks: Array<{ placeholder: string; url: string; appId: string | null }> = [];
  const bangumiLinks: Array<{ placeholder: string; url: string; subjectId: string | null }> = [];
  const neteaseLinks: Array<{ placeholder: string; url: string; songId: string | null }> = [];
  const bilibiliLinks: Array<{ placeholder: string; url: string; videoId: { type: 'bv' | 'av', id: string } | null }> = [];
  const githubLinks: Array<{ placeholder: string; url: string; repo: { owner: string; repo: string } | null }> = [];
  const tmdbLinks: Array<{ placeholder: string; url: string; mediaId: { type: 'movie' | 'tv'; id: string } | null }> = [];
  const youtubeLinks: Array<{ placeholder: string; url: string; videoId: string | null }> = [];
  const tiktokLinks: Array<{ placeholder: string; url: string; videoInfo: any | null }> = [];
  const vndbLinks: Array<{ placeholder: string; url: string; vnId: string | null }> = [];
  let processedContent = content;
  
  // Detect Steam links in markdown format [text](url) or bare URLs
  const steamLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/store\.steampowered\.com\/app\/\d+[^\)]*)\)|(https?:\/\/store\.steampowered\.com\/app\/\d+\S*))/g;
  
  // Detect Bangumi links
  const bangumiLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:bgm|bangumi)\.tv\/subject\/\d+[^\)]*)\)|(https?:\/\/(?:bgm|bangumi)\.tv\/subject\/\d+\S*))/g;
  
  // Detect NetEase Cloud Music links
  const neteaseLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:y\.)?music\.163\.com[^)]*id=\d+[^\)]*)\)|(https?:\/\/(?:y\.)?music\.163\.com[^\s]*id=\d+\S*))/g;
  
  // Detect Bilibili video links
  const bilibiliLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.)?bilibili\.com\/video\/(?:BV[a-zA-Z0-9]+|av\d+)[^\)]*)\)|(https?:\/\/(?:www\.)?bilibili\.com\/video\/(?:BV[a-zA-Z0-9]+|av\d+)\S*))/g;
  
  // Detect GitHub repository links
  const githubLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.)?github\.com\/[^\/)]+\/[^\/)]+[^\)]*)\)|(https?:\/\/(?:www\.)?github\.com\/[^\/)]+\/[^\/)\s]+))/g;
  
  // Detect TMDB movie/TV links
  const tmdbLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.)?themoviedb\.org\/(?:movie|tv)\/\d+[^\)]*)\)|(https?:\/\/(?:www\.)?themoviedb\.org\/(?:movie|tv)\/\d+\S*))/g;
  
  // Detect YouTube video links
  const youtubeLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)[^\)]*)\)|(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?[^\s]*v=[a-zA-Z0-9_-]{11}|youtu\.be\/[a-zA-Z0-9_-]{11})\S*))/g;
  
  // Detect TikTok video links
  const tiktokLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.|vm\.)?tiktok\.com\/[^\)]+)\)|(https?:\/\/(?:www\.|vm\.)?tiktok\.com\/\S+))/g;
  
  // Detect VNDB visual novel links
  const vndbLinkPattern = /(?:\[([^\]]*)\]\((https?:\/\/(?:www\.)?vndb\.org\/v\d+[^\)]*)\)|(https?:\/\/(?:www\.)?vndb\.org\/v\d+\S*))/g;
  
  let match;
  let index = 0;
  while ((match = steamLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const appId = extractSteamAppId(url);
    
    if (appId) {
      // Use HTML comment as placeholder to avoid Markdown parsing
      const placeholder = `<!--STEAMCARD${index}-->`;
      steamLinks.push({ placeholder, url, appId });
      processedContent = processedContent.replace(match[0], placeholder);
      index++;
    }
  }
  
  // Detect Bangumi links
  let bangumiIndex = 0;
  while ((match = bangumiLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const subjectId = extractBangumiId(url);
    
    if (subjectId) {
      const placeholder = `<!--BANGUMICARD${bangumiIndex}-->`;
      bangumiLinks.push({ placeholder, url, subjectId });
      processedContent = processedContent.replace(match[0], placeholder);
      bangumiIndex++;
    }
  }
  
  // Detect NetEase links
  let neteaseIndex = 0;
  while ((match = neteaseLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const songId = extractNeteaseSongId(url);
    
    if (songId) {
      const placeholder = `<!--NETEASECARD${neteaseIndex}-->`;
      neteaseLinks.push({ placeholder, url, songId });
      processedContent = processedContent.replace(match[0], placeholder);
      neteaseIndex++;
    }
  }
  
  // Detect Bilibili links
  let bilibiliIndex = 0;
  while ((match = bilibiliLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const videoId = extractBilibiliVideoId(url);
    
    if (videoId) {
      const placeholder = `<!--BILIBILICARD${bilibiliIndex}-->`;
      bilibiliLinks.push({ placeholder, url, videoId });
      processedContent = processedContent.replace(match[0], placeholder);
      bilibiliIndex++;
    }
  }
  
  // Detect GitHub links
  let githubIndex = 0;
  while ((match = githubLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const repo = extractGitHubRepo(url);
    
    if (repo) {
      const placeholder = `<!--GITHUBCARD${githubIndex}-->`;
      githubLinks.push({ placeholder, url, repo });
      processedContent = processedContent.replace(match[0], placeholder);
 githubIndex++;
    }
  }
  
  // Detect TMDB links
  let tmdbIndex = 0;
  while ((match = tmdbLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const mediaId = extractTMDBId(url);
    
    if (mediaId) {
      const placeholder = `<!--TMDBCARD${tmdbIndex}-->`;
      tmdbLinks.push({ placeholder, url, mediaId });
      processedContent = processedContent.replace(match[0], placeholder);
      tmdbIndex++;
    }
  }
  
  // Detect YouTube links
  let youtubeIndex = 0;
  while ((match = youtubeLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const videoId = extractYouTubeVideoId(url);
    
    if (videoId) {
      const placeholder = `<!--YOUTUBECARD${youtubeIndex}-->`;
      youtubeLinks.push({ placeholder, url, videoId });
      processedContent = processedContent.replace(match[0], placeholder);
      youtubeIndex++;
    }
  }
  
  // Detect TikTok links
  let tiktokIndex = 0;
  while ((match = tiktokLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const videoInfo = extractTikTokId(url);
    
    if (videoInfo) {
      const placeholder = `<!--TIKTOKCARD${tiktokIndex}-->`;
      tiktokLinks.push({ placeholder, url, videoInfo });
      processedContent = processedContent.replace(match[0], placeholder);
      tiktokIndex++;
    }
  }
  
  // Detect VNDB links
  let vndbIndex = 0;
  while ((match = vndbLinkPattern.exec(content)) !== null) {
    const url = match[2] || match[3];
    const vnId = extractVNDBId(url);
    
    if (vnId) {
      const placeholder = `<!--VNDBCARD${vndbIndex}-->`;
      vndbLinks.push({ placeholder, url, vnId });
      processedContent = processedContent.replace(match[0], placeholder);
      vndbIndex++;
    }
  }
  
  // Render markdown
  let html = await marked.parse(processedContent, {
    breaks: true,
    gfm: true,
  });

  
  // Extract all images and wrap them in a grid layout
  const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
  const images: string[] = [];
  let imgMatch;
  while ((imgMatch = imgRegex.exec(html)) !== null) {
    images.push(imgMatch[1]);
  }
  
  if (images.length > 0) {
    // Remove all <p> tags containing only images
    html = html.replace(/<p>\s*(<img[^>]+>)\s*<\/p>/g, '$1');
    // Remove standalone img tags (we'll add them back in a grid)
    html = html.replace(/<img[^>]+src="([^"]+)"[^>]*>/g, '');
    // Clean up empty paragraphs
    html = html.replace(/<p>\s*<\/p>/g, '');
    
    let gridHtml: string;
    
    if (images.length === 1) {
      // Single image: only limit max height for very tall images, otherwise keep original ratio
      gridHtml = `<div class="moment-image-single my-3">
        <a href="${images[0]}" data-fancybox="gallery-${momentId}" class="cursor-zoom-in inline-block rounded-lg overflow-hidden bg-base-200">
          <img src="${images[0]}" alt="Moment image" loading="lazy" class="max-w-full max-h-96 object-contain transition-transform duration-500 hover:scale-105" />
        </a>
      </div>`;
    } else {
      // Multiple images: 2 columns, square aspect ratio
      gridHtml = `<div class="moment-image-grid grid grid-cols-2 gap-2 my-3">
        ${images.map(src => `
          <a href="${src}" data-fancybox="gallery-${momentId}" class="cursor-zoom-in block rounded-lg overflow-hidden aspect-square bg-base-200">
            <img src="${src}" alt="Moment image" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" />
          </a>
        `).join('')}
      </div>`;
    }
    
    // Append grid at the end of HTML content
    html = html.trim() + gridHtml;
  }
  
  // Replace Steam placeholders with actual cards
  for (const { placeholder, url, appId } of steamLinks) {
    if (!appId) continue;
    const gameData = await getSteamGameInfo(appId);
    
    if (gameData && gameData.success && gameData.data) {
      const game = gameData.data;
      const steamUrl = `https://store.steampowered.com/app/${appId}`;
      
      // Build price display
      const priceDisplay = game.is_free
        ? "ÂÖçË¥πÊ∏∏Áé©"
        : game.price_overview
          ? game.price_overview.final_formatted
          : "‰ª∑Ê†ºÊú™Áü•";
      
      const hasDiscount = !!(game.price_overview && game.price_overview.discount_percent > 0);
      
      // Build platform icons HTML
      let platformIcons = '<div class="flex gap-1 flex-shrink-0">';
      if (game.platforms.windows) {
        platformIcons += '<svg class="w-4 h-4 text-base-content/60" viewBox="0 0 24 24"><path fill="currentColor" d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg>';
      }
      if (game.platforms.mac) {
        platformIcons += '<svg class="w-4 h-4 text-base-content/60" viewBox="0 0 24 24"><path fill="currentColor" d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>';
      }
      if (game.platforms.linux) {
        platformIcons += '<svg class="w-4 h-4 text-base-content/60" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.53918 2.40715C4.82145 1.0075 6.06066 0 7.49996 0C8.93926 0 10.1785 1.0075 10.4607 2.40715L10.798 4.07944C10.9743 4.9539 11.3217 5.78562 11.8205 6.52763L12.4009 7.39103C12.7631 7.92978 12.9999 8.5385 13.0979 9.17323C13.6747 9.22167 14.1803 9.58851 14.398 10.1283L14.8897 11.3474C15.1376 11.962 14.9583 12.665 14.4455 13.0887L12.5614 14.6458C12.0128 15.0992 11.2219 15.1193 10.6506 14.6944L9.89192 14.1301C9.88189 14.1227 9.87197 14.1151 9.86216 14.1074C9.48973 14.2075 9.09793 14.261 8.69355 14.261H6.30637C5.90201 14.261 5.51023 14.2076 5.13782 14.1074C5.12802 14.1151 5.11811 14.1227 5.10808 14.1301L4.34942 14.6944C3.77811 15.1193 2.98725 15.0992 2.43863 14.6458L0.55446 13.0887C0.0417175 12.665 -0.1376 11.962 0.110281 11.3474L0.602025 10.1283C0.819715 9.58854 1.32527 9.2217 1.90198 9.17324C2 8.5385 2.2368 7.92978 2.59897 7.39103L3.17938 6.52763C3.67818 5.78562 4.02557 4.9539 4.20193 4.07944L4.53918 2.40715ZM10.8445 9.47585C10.6345 9.63293 10.4642 9.84382 10.3561 10.0938L9.58799 11.8713C9.20026 12.0979 8.75209 12.2237 8.28465 12.2237H6.7153C6.24789 12.2237 5.79975 12.0979 5.41203 11.8714L4.64386 10.0938C4.53581 9.8438 4.36552 9.6329 4.15546 9.47582C4.18121 9.15355 4.2689 8.83503 4.41853 8.53826L5.67678 6.04259L5.68433 6.05007C6.68715 7.04458 8.31304 7.04458 9.31585 6.05007L9.32324 6.04274L10.5814 8.53825C10.7311 8.83504 10.8187 9.15357 10.8445 9.47585ZM9.04068 4.26906V3.05592H8.01353V3.85713C8.23151 3.90123 8.44506 3.97371 8.64848 4.07458L9.04068 4.26906ZM6.98638 3.85718V3.05592H5.95923V4.26919L6.3517 4.07458C6.55504 3.97375 6.7685 3.90129 6.98638 3.85718ZM2.03255 10.1864C1.82255 10.1864 1.6337 10.3132 1.55571 10.5066L1.06397 11.7257C0.981339 11.9306 1.04111 12.1649 1.21203 12.3062L3.0962 13.8633C3.27907 14.0144 3.54269 14.0211 3.73313 13.8795L4.49179 13.3152C4.6813 13.1743 4.74901 12.923 4.6557 12.7071L3.69976 10.4951C3.61884 10.3078 3.43316 10.1864 3.22771 10.1864H2.03255ZM13.4443 10.5066C13.3663 10.3132 13.1775 10.1864 12.9674 10.1864H11.7723C11.5668 10.1864 11.3812 10.3078 11.3002 10.4951L10.3443 12.7071C10.251 12.923 10.3187 13.1743 10.5082 13.3152L11.2669 13.8795C11.4573 14.0211 11.7209 14.0144 11.9038 13.8633L13.788 12.3062C13.9589 12.1649 14.0187 11.9306 13.936 11.7257L13.4443 10.5066ZM6.81106 4.98568C7.24481 4.7706 7.75537 4.7706 8.18912 4.98568L8.68739 5.23275L8.58955 5.32978C7.98786 5.92649 7.01232 5.92649 6.41063 5.32978L6.31279 5.23275L6.81106 4.98568Z" fill="currentColor"/></svg>';
      }
      platformIcons += '</div>';
      
      // Build genres HTML
      let genresHtml = '';
      if (game.genres && game.genres.length > 0) {
        genresHtml = '<div class="flex flex-wrap gap-1 mb-2">';
        game.genres.slice(0, 5).forEach(genre => {
          genresHtml += `<span class="badge badge-outline badge-sm">${escapeHtml(genre.description)}</span>`;
        });
        genresHtml += '</div>';
      }
      
      // Build Steam card HTML
      const steamCardHtml = `
        <div class="not-prose steam-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${steamUrl}" target="_blank" rel="noopener noreferrer" class="block" aria-label="Visit ${escapeHtml(game.name)} on Steam">
            <div class="relative w-full h-40 bg-base-300 overflow-hidden">
              <img src="${game.header_image}" alt="${escapeHtml(game.name)}" loading="lazy" class="w-full h-full object-cover">
              <div class="absolute bottom-2 left-2">
                ${hasDiscount && game.price_overview ? `
                  <div class="flex items-center gap-2">
                    <div class="badge badge-error badge-sm font-bold">-${game.price_overview.discount_percent}%</div>
                    <div class="bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded text-xs">
                      <div class="line-through text-base-content/60">${game.price_overview.initial_formatted}</div>
                      <div class="font-bold text-success">${game.price_overview.final_formatted}</div>
                    </div>
                  </div>
                ` : `
                  <div class="bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded">
                    <div class="font-bold text-sm ${game.is_free ? 'text-success' : ''}">${priceDisplay}</div>
                  </div>
                `}
              </div>
            </div>
            <div class="p-3">
              <div class="flex items-start justify-between gap-2 mb-1">
                <h3 class="font-bold text-base line-clamp-1">${escapeHtml(game.name)}</h3>
                ${platformIcons}
              </div>
              <p class="text-sm text-base-content/80 line-clamp-2 mb-2">${escapeHtml(game.short_description)}</p>
              ${genresHtml}
              <div class="flex items-center gap-1 text-primary text-xs mt-2">
                <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0zM7.54 18.21l-1.473-.61c.262.543.714.999 1.314 1.25 1.297.539 2.793-.076 3.332-1.375.263-.63.264-1.319.005-1.949s-.75-1.121-1.377-1.383c-.624-.26-1.29-.249-1.878-.03l1.523.63c.956.4 1.409 1.5 1.009 2.455-.397.957-1.497 1.41-2.454 1.012H7.54zm11.415-9.303c0-1.662-1.353-3.015-3.015-3.015-1.665 0-3.015 1.353-3.015 3.015 0 1.665 1.35 3.015 3.015 3.015 1.663 0 3.015-1.35 3.015-3.015zm-5.273-.005c0-1.252 1.013-2.266 2.265-2.266 1.249 0 2.266 1.014 2.266 2.266 0 1.251-1.017 2.265-2.266 2.265-1.253 0-2.265-1.014-2.265-2.265z"/>
                </svg>
                <span class="font-medium">Âú® Steam ‰∏äÊü•Áúã</span>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, steamCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace Bangumi placeholders with actual cards
  for (const { placeholder, url, subjectId } of bangumiLinks) {
    if (!subjectId) continue;
    const subjectData = await getBangumiSubject(subjectId);
    
    if (subjectData) {
      const subject = subjectData;
      const bangumiUrl = `https://bgm.tv/subject/${subjectId}`;
      const displayName = subject.name_cn || subject.name;
      const originalName = subject.name_cn ? subject.name : '';
      
      // Build tags HTML
      let tagsHtml = '';
      if (subject.tags && subject.tags.length > 0) {
        tagsHtml = '<div class="flex flex-wrap gap-1 mb-2">';
        subject.tags.slice(0, 5).forEach(tag => {
          tagsHtml += `<span class="badge badge-outline badge-sm">${escapeHtml(tag.name)}</span>`;
        });
        tagsHtml += '</div>';
      }
      
      // Build Bangumi card HTML
      const bangumiCardHtml = `
        <div class="not-prose bangumi-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${bangumiUrl}" target="_blank" rel="noopener noreferrer" class="block" aria-label="Visit ${escapeHtml(displayName)} on Bangumi">
            <div class="relative w-full h-40 bg-base-300 overflow-hidden">
              <img src="${subject.images.large}" alt="${escapeHtml(displayName)}" loading="lazy" class="w-full h-full object-cover">
              ${subject.rating && subject.rating.score > 0 ? `
                <div class="absolute bottom-2 left-2 bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded flex items-center gap-1">
                  <svg class="w-4 h-4 text-warning" viewBox="0 0 24 24" fill="currentColor"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg>
                  <span class="font-bold text-sm">${subject.rating.score.toFixed(1)}</span>
                  <span class="text-xs text-base-content/60">(${subject.rating.total})</span>
                </div>
              ` : ''}
            </div>
            <div class="p-3">
              <div class="mb-1">
                <h3 class="font-bold text-base line-clamp-1 break-words">${escapeHtml(displayName)}</h3>
                ${originalName ? `<p class="text-xs text-base-content/60 line-clamp-1 break-words">${escapeHtml(originalName)}</p>` : ''}
              </div>
              <p class="text-sm text-base-content/80 line-clamp-2 mb-2 break-words">${escapeHtml(subject.summary || 'ÊöÇÊó†ÁÆÄ‰ªã')}</p>
              ${tagsHtml}
              <div class="flex items-center gap-1 text-primary text-xs mt-2">
                <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19,2L14,6.5V17.5L19,13V2M6.5,5C4.55,5 2.45,5.4 1,6.5V21.16C1,21.41 1.25,21.66 1.5,21.66C1.6,21.66 1.65,21.59 1.75,21.59C3.1,20.94 5.05,20.5 6.5,20.5C8.45,20.5 10.55,20.9 12,22C13.35,21.15 15.8,20.5 17.5,20.5C19.15,20.5 20.85,20.81 22.25,21.56C22.35,21.61 22.4,21.59 22.5,21.59C22.75,21.59 23,21.34 23,21.09V6.5C22.4,6.05 21.75,5.75 21,5.5V19C19.9,18.65 18.7,18.5 17.5,18.5C15.8,18.5 13.35,19.15 12,20V6.5C10.55,5.4 8.45,5 6.5,5Z"/>
                </svg>
                <span class="font-medium">Âú® Bangumi ‰∏äÊü•Áúã</span>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, bangumiCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace NetEase placeholders with actual cards
  for (const { placeholder, url, songId } of neteaseLinks) {
    if (!songId) continue;
    const songData = await getNeteaseSongInfo(songId);
    
    if (songData) {
      const neteaseUrl = `https://music.163.com/#/song?id=${songId}`;
      const artistNames = songData.artists.map(a => a.name).join(' / ');
      const duration = formatDuration(songData.duration);
      
      const neteaseCardHtml = `
        <div class="not-prose netease-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${neteaseUrl}" target="_blank" rel="noopener noreferrer" class="block" aria-label="Play ${escapeHtml(songData.name)} on NetEase Cloud Music">
            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden shadow-md shrink-0">
                <img src="${songData.album.picUrl}" alt="${escapeHtml(songData.album.name)}" loading="lazy" class="w-full h-full object-cover">
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-bold text-base line-clamp-1 mb-0.5 sm:mb-1 break-words">${escapeHtml(songData.name)}</h3>
                <p class="text-sm text-base-content/70 line-clamp-1 mb-0.5 sm:mb-1 break-words">${escapeHtml(artistNames)}</p>
                <p class="text-xs text-base-content/60 line-clamp-1 break-words">${escapeHtml(songData.album.name)}</p>
              </div>
              <div class="flex flex-col items-end gap-1 sm:gap-2 shrink-0 ml-1">
                <div class="flex items-center gap-1 text-primary">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M10,16.5V7.5L16,12M12,13.5L13.5,12.75L12,12V13.5Z"/>
                  </svg>
                  <span class="text-[10px] sm:text-xs font-medium truncate max-w-[40px] sm:max-w-none">ÁΩëÊòì‰∫ë</span>
                </div>
                <span class="text-[10px] sm:text-xs text-base-content/60">${duration}</span>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, neteaseCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace Bilibili placeholders with actual cards
  for (const { placeholder, url, videoId } of bilibiliLinks) {
    if (!videoId) continue;
    const videoData = await getBilibiliVideoInfo(videoId);
    
    if (videoData) {
      const bilibiliUrl = `https://www.bilibili.com/video/${videoData.bvid}`;
      const viewCount = formatViewCount(videoData.stat.view);
      const duration = formatVideoDuration(videoData.duration);
      
      const bilibiliCardHtml = `
        <div class="not-prose bilibili-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${bilibiliUrl}" target="_blank" rel="noopener noreferrer" class="block" aria-label="Watch ${escapeHtml(videoData.title)} on Bilibili">
            <div class="relative w-full h-48 bg-base-300 overflow-hidden">
              <img src="${videoData.pic}" alt="${escapeHtml(videoData.title)}" loading="lazy" class="w-full h-full object-cover" referrerpolicy="no-referrer">
              <div class="absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-white text-xs font-medium">
                ${duration}
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-base line-clamp-2 mb-2 break-words">${escapeHtml(videoData.title)}</h3>
              <div class="flex items-center gap-2 mb-3">
                <img src="${videoData.owner.face}" alt="${escapeHtml(videoData.owner.name)}" class="w-6 h-6 rounded-full" referrerpolicy="no-referrer">
                <span class="text-sm text-base-content/70 truncate">${escapeHtml(videoData.owner.name)}</span>
              </div>
              <div class="flex items-center justify-between text-xs text-base-content/60">
                <div class="flex items-center gap-4">
                  <span>‚ñ∂ ${viewCount}</span>
                  <span>üí¨ ${formatViewCount(videoData.stat.danmaku)}</span>
                </div>
                <div class="flex items-center gap-1 text-primary">
                  <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373z"/>
                  </svg>
                  <span class="font-medium">ÂìîÂì©ÂìîÂì©</span>
                </div>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, bilibiliCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace GitHub placeholders with actual cards
  for (const { placeholder, url, repo } of githubLinks) {
    if (!repo) continue;
    const repoData = await getGitHubRepoInfo(repo.owner, repo.repo);
    
    if (repoData) {
      const stars = formatGitHubCount(repoData.stargazers_count);
      const forks = formatGitHubCount(repoData.forks_count);
      const languageColor = getLanguageColor(repoData.language);
      
      const githubCardHtml = `
        <div class="not-prose github-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${repoData.html_url}" target="_blank" rel="noopener noreferrer" class="block" aria-label="View ${escapeHtml(repoData.full_name)} on GitHub">
            <div class="p-4">
              <div class="flex items-start gap-3 mb-3">
                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                <div class="flex-1 min-w-0">
                  <h3 class="font-bold text-base mb-1 break-words">${escapeHtml(repoData.full_name)}</h3>
                  <p class="text-sm text-base-content/70 line-clamp-2 break-words">${escapeHtml(repoData.description || 'Êó†ÊèèËø∞')}</p>
                </div>
              </div>
              <div class="flex items-center gap-4 text-xs text-base-content/60">
                ${repoData.language ? `
                  <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${languageColor}"></span>
                    <span>${escapeHtml(repoData.language)}</span>
                  </div>
                ` : ''}
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 .25a.75.75 0 01.673.418l1.882 3.815 4.21.612a.75.75 0 01.416 1.279l-3.046 2.97.719 4.192a.75.75 0 01-1.088.791L8 12.347l-3.766 1.98a.75.75 0 01-1.088-.79l.72-4.194L.818 6.374a.75.75 0 01.416-1.28l4.21-.611L7.327.668A.75.75 0 018 .25z"/>
                  </svg>
                  <span>${stars}</span>
                </div>
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75v-.878a2.25 2.25 0 111.5 0v.878a2.25 2.25 0 01-2.25 2.25h-1.5v2.128a2.251 2.251 0 11-1.5 0V8.5h-1.5A2.25 2.25 0 013.5 6.25v-.878a2.25 2.25 0 111.5 0zM5 3.25a.75.75 0 100-1.5.75.75 0 000 1.5zm6 0a.75.75 0 100-1.5.75.75 0 000 1.5zm-3 9.5a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
                  </svg>
                  <span>${forks}</span>
                </div>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, githubCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace TMDB placeholders with actual cards
  for (const { placeholder, url, mediaId } of tmdbLinks) {
    if (!mediaId) continue;
    
    const mediaData = mediaId.type === 'movie' 
      ? await getTMDBMovieInfo(mediaId.id)
      : await getTMDBTVInfo(mediaId.id);
    
    if (mediaData) {
      const title = 'title' in mediaData ? mediaData.title : mediaData.name;
      const originalTitle = 'original_title' in mediaData ? mediaData.original_title : mediaData.original_name;
      const releaseDate = 'release_date' in mediaData ? mediaData.release_date : mediaData.first_air_date;
      const year = releaseDate ? new Date(releaseDate).getFullYear() : 'Êú™Áü•';
      const rating = formatTMDBRating(mediaData.vote_average);
      const posterUrl = getTMDBImageUrl(mediaData.poster_path);
      const genres = mediaData.genres.slice(0, 3).map(g => g.name).join(' / ');
      const mediaType = mediaId.type === 'movie' ? 'ÁîµÂΩ±' : 'ÂâßÈõÜ';
      const extraInfo = mediaId.type === 'movie' && 'runtime' in mediaData
        ? formatRuntime(mediaData.runtime)
        : `${(mediaData as any).number_of_seasons} Â≠£`;
      
      const tmdbCardHtml = `
        <div class="not-prose tmdb-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
          <a href="${url}" target="_blank" rel="noopener noreferrer" class="block" aria-label="View ${escapeHtml(title)} on TMDB">
            <div class="flex flex-col xs:flex-row gap-3 sm:gap-4 p-3 sm:p-4">
              <div class="w-full xs:w-32 h-64 xs:h-48 rounded-lg overflow-hidden shadow-md shrink-0 bg-base-300">
                <img src="${posterUrl}" alt="${escapeHtml(title)}" loading="lazy" class="w-full h-full object-cover" referrerpolicy="no-referrer">
              </div>
              <div class="flex-1 min-w-0 flex flex-col">
                <div class="mb-2">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="badge badge-primary badge-sm">${mediaType}</span>
                    <span class="text-xs text-base-content/60">${year}</span>
                  </div>
                  <h3 class="font-bold text-base line-clamp-1 mb-0.5 sm:mb-1 break-words">${escapeHtml(title)}</h3>
                  ${originalTitle !== title ? `<p class="text-xs text-base-content/60 line-clamp-1 mb-2 break-words">${escapeHtml(originalTitle)}</p>` : ''}
                </div>
                <p class="text-sm text-base-content/70 line-clamp-2 xs:line-clamp-3 mb-auto break-words">${escapeHtml(mediaData.overview || 'ÊöÇÊó†ÁÆÄ‰ªã')}</p>
                <div class="flex items-center gap-x-4 gap-y-1 flex-wrap text-xs text-base-content/60 mt-3">
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-yellow-500" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span class="font-medium">${rating}</span>
                  </div>
                  ${genres ? `<span class="truncate max-w-[120px]">${escapeHtml(genres)}</span>` : ''}
                  <span>${extraInfo}</span>
                </div>
              </div>
            </div>
          </a>
        </div>
      `;
      
      html = html.replace(placeholder, tmdbCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace YouTube placeholders with actual cards
  for (const { placeholder, url, videoId } of youtubeLinks) {
    if (!videoId) continue;
    const videoData = await getYouTubeVideoInfo(videoId);
    
    if (videoData) {
      const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;
      const viewCount = formatYouTubeCount(videoData.statistics.viewCount);
      const duration = parseYouTubeDuration(videoData.contentDetails.duration);
      const thumbnail = getYouTubeThumbnail(videoData.snippet.thumbnails);
      
      const youtubeCardHtml = `<div class="not-prose youtube-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden"><a href="${youtubeUrl}" target="_blank" rel="noopener noreferrer" class="block" aria-label="Watch ${escapeHtml(videoData.snippet.title)} on YouTube"><div class="relative w-full h-48 bg-base-300 overflow-hidden"><img src="${thumbnail}" alt="${escapeHtml(videoData.snippet.title)}" loading="lazy" class="w-full h-full object-cover"><div class="absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-white text-xs font-medium">${duration}</div></div><div class="p-4"><h3 class="font-bold text-base line-clamp-2 mb-2">${escapeHtml(videoData.snippet.title)}</h3><div class="flex items-center gap-2 mb-3"><span class="text-sm text-base-content/70">${escapeHtml(videoData.snippet.channelTitle)}</span></div><div class="flex items-center justify-between text-xs text-base-content/60"><div class="flex items-center gap-4"><span>‚ñ∂ ${viewCount} Ê¨°ËßÇÁúã</span></div><div class="flex items-center gap-1 text-primary"><svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg><span class="font-medium">YouTube</span></div></div></div></a></div>`;
      
      html = html.replace(placeholder, youtubeCardHtml);
    } else {
      // Fallback to a simple link if data fetch failed
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace TikTok placeholders with cards
  for (const { placeholder, url, videoInfo } of tiktokLinks) {
    if (!videoInfo) continue;
    
    const videoData = await getTikTokVideoInfo(url);
    
    if (videoData) {
      const tiktokCardHtml = `<div class="not-prose tiktok-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden"><a href="${url}" target="_blank" rel="noopener noreferrer" class="block" aria-label="View ${escapeHtml(videoData.title)} on TikTok"><div class="flex flex-col xs:flex-row gap-3 sm:gap-4 p-3 sm:p-4"><div class="w-full xs:w-32 h-48 xs:h-40 rounded-lg overflow-hidden shadow-md shrink-0 bg-base-300"><img src="${videoData.thumbnail_url}" alt="${escapeHtml(videoData.title)}" loading="lazy" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0 flex flex-col"><div class="mb-2"><div class="flex items-center gap-2 mb-1"><span class="badge badge-error badge-sm font-medium">TikTok</span><span class="text-xs text-base-content/60 truncate">@${escapeHtml(videoData.author_name)}</span></div><h3 class="font-bold text-base line-clamp-2 mb-1 break-words">${escapeHtml(videoData.title)}</h3></div><div class="mt-auto"><div class="flex items-center gap-2 text-primary text-sm"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg><span>Âú® TikTok ‰∏äËßÇÁúã</span></div></div></div></div></a></div>`;
      
      html = html.replace(placeholder, tiktokCardHtml);
    } else {
      // Fallback to a simple link
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  // Replace VNDB placeholders with cards
  for (const { placeholder, url, vnId } of vndbLinks) {
    if (!vnId) continue;
    
    const vnData = await getVNDBInfo(vnId);
    
    if (vnData) {
      const rating = vnData.rating ? formatVNDBRating(vnData.rating) : 'N/A';
      const length = getVNDBLengthLabel(vnData.length);
      const developer = vnData.developers && vnData.developers.length > 0 ? vnData.developers[0].name : 'Unknown';
      const imageUrl = vnData.image?.url || '';
      
      const vndbCardHtml = `<div class="not-prose vndb-card-moment my-4 card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden"><a href="${url}" target="_blank" rel="noopener noreferrer" class="block" aria-label="View ${escapeHtml(vnData.title)} on VNDB"><div class="flex flex-col xs:flex-row gap-3 sm:gap-4 p-3 sm:p-4"><div class="w-full xs:w-32 h-56 xs:h-44 rounded-lg overflow-hidden shadow-md shrink-0 bg-base-300">${imageUrl ? `<img src="${imageUrl}" alt="${escapeHtml(vnData.title)}" loading="lazy" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-base-content/30"><svg class="w-12 h-12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>'}</div><div class="flex-1 min-w-0 flex flex-col"><div class="mb-2"><div class="flex items-center gap-2 mb-1"><span class="badge badge-info badge-sm font-medium">VNDB</span><span class="text-xs text-base-content/60 truncate">${escapeHtml(developer)}</span></div><h3 class="font-bold text-base line-clamp-2 mb-1 break-words">${escapeHtml(vnData.title)}</h3>${vnData.alttitle ? `<p class="text-sm text-base-content/60 line-clamp-1 break-words">${escapeHtml(vnData.alttitle)}</p>` : ''}</div><div class="mt-auto space-y-1"><div class="flex items-center gap-3 text-sm"><div class="flex items-center gap-1"><svg class="w-4 h-4 text-warning" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span class="font-medium">${rating}</span></div><div class="text-base-content/60">‚Ä¢</div><div class="text-base-content/60 truncate">${length}</div></div><div class="flex items-center gap-2 text-primary text-sm"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg><span>Âú® VNDB ‰∏äÊü•Áúã</span></div></div></div></div></a></div>`;
      
      html = html.replace(placeholder, vndbCardHtml);
    } else {
      // Fallback to a simple link
      html = html.replace(placeholder, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${url}</a>`);
    }
  }
  
  return html;
}
---

<BaseLayout title="Moments" isIndexed={false}>
  <div class="max-w-4xl mx-auto space-y-8 py-8 px-2 md:px-0">
    <div class="flex items-center gap-3 mb-6">
       <Icon name="lucide:camera" class="w-8 h-8 text-primary" />
       <h1 class="text-3xl font-bold">Moments</h1>
    </div>

    <!-- Editor Component (Client-side) -->
    <MomentsEditor client:only="react" />

    <!-- Timeline -->
    <div class="space-y-6">
      {page.data.map(async (moment) => {
        const htmlContent = await renderContent(moment.content, moment.id);
        return (
          <Card class="p-4 sm:p-6 transition-all hover:shadow-lg">
            <div class="flex gap-3 sm:gap-4">
              <div class="flex-shrink-0">
                 <div class="w-12 h-12 rounded-full ring-2 ring-primary/20 overflow-hidden">
                   <img src="https://blog.000.moe/images/uploads/1768632093006-5ozymr.jpg" alt="Avatar" class="w-full h-full object-cover" />
                 </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-bold text-lg">Miuna</span>
                  <span class="text-xs text-base-content/60" title={dayjs(moment.createdAt).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss')}>
                    {dayjs(moment.createdAt).tz('Asia/Shanghai').format('MM-DD HH:mm')}
                  </span>
                </div>
                
                <div class="prose prose-base dark:prose-invert max-w-none mb-4 break-words" set:html={htmlContent} />
                
                {moment.images && moment.images.length > 0 && (
                  <div class={`grid gap-2 ${moment.images.length === 1 ? 'grid-cols-1' : moment.images.length === 2 ? 'grid-cols-2' : 'grid-cols-3'}`}>
                    {moment.images.map((img) => (
                      <div class="aspect-square rounded-lg overflow-hidden border border-base-200 group relative">
                        <a href={img} data-fancybox={`gallery-${moment.id}`} class="block w-full h-full cursor-zoom-in">
                          <img src={img} alt="Moment image" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                        </a>
                      </div>
                    ))}
                  </div>
                )}
  
                <div class="flex justify-between items-end mt-4">
                  <div class="flex flex-wrap gap-2">
                    {moment.tags && moment.tags.map(tag => (
                      <span class="badge badge-ghost badge-sm text-base-content/60">#{tag}</span>
                    ))}
                  </div>
                  
                  <MomentDeleteButton client:only="react" id={moment.id} />
                </div>
              </div>
            </div>
          </Card>
        );
      })}
  
      {page.data.length === 0 && (
        <div class="text-center py-20 text-base-content/40">
          <Icon name="lucide:ghost" class="w-16 h-16 mx-auto mb-4" />
          <p>No moments yet...</p>
        </div>
      )}
    </div>

    <!-- Pagination -->
    <div class="mt-10">
      <Pagination page={page} totalPages={totalPages} pageLinks={pageLinks} baseUrl="/moments" />
    </div>

  </div>

  <script>
    import { Fancybox } from "@fancyapps/ui";
    
    function initFancybox() {
      // Destroy existing instances first
      Fancybox.destroy();
      
      // Bind to all fancybox elements
      Fancybox.bind("[data-fancybox]", {
        Toolbar: {
          display: {
            left: ["infobar"],
            middle: [
              "zoomIn",
              "zoomOut",
              "toggle1to1",
              "rotateCCW",
              "rotateCW",
              "flipX",
              "flipY",
            ],
            right: ["slideshow", "thumbs", "close"],
          },
        },
      } as any);
    }
    
    // Initialize on page load
    document.addEventListener("astro:page-load", initFancybox);
    
    // Also initialize immediately for direct page loads
    if (document.readyState === "complete" || document.readyState === "interactive") {
      initFancybox();
    } else {
      document.addEventListener("DOMContentLoaded", initFancybox);
    }
  </script>

  <style>
    /* Ensure cards don't overflow on mobile */
    .steam-card-moment,
    .bangumi-card-moment,
    .netease-card-moment,
    .bilibili-card-moment,
    .github-card-moment,
    .tmdb-card-moment,
    .tiktok-card-moment,
    .vndb-card-moment,
    .youtube-card-moment {
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    /* Ensure images don't overflow */
    .steam-card-moment img,
    .bangumi-card-moment img,
    .netease-card-moment img,
    .bilibili-card-moment img,
    .github-card-moment img,
    .tmdb-card-moment img,
    .tiktok-card-moment img,
    .vndb-card-moment img,
    .youtube-card-moment img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .steam-card-moment,
      .bangumi-card-moment,
      .netease-card-moment,
      .bilibili-card-moment,
      .github-card-moment,
      .tmdb-card-moment,
      .tiktok-card-moment,
      .vndb-card-moment,
      .youtube-card-moment {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
        width: calc(100% + 1rem);
      }
    }
    
    /* Global word break to prevent overflow */
    :global(.prose) {
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    
    /* Extra small screen helper */
    @media (min-width: 480px) {
      .xs\:flex-row {
        flex-direction: row !important;
      }
      .xs\:w-32 {
        width: 8rem !important;
      }
      .xs\:h-40 {
        height: 10rem !important;
      }
      .xs\:h-44 {
        height: 11rem !important;
      }
    }
  </style>
</BaseLayout>
